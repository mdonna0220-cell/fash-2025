<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æœé¥°è®¾è®¡åŠ©æ‰‹ (å®‰å…¨åå°ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; 
            color: #1f2937;
        }
        .container { max-width: 960px; position: relative; }
        .btn { transition: all 0.2s ease; }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { transform: none; }
        .btn-primary { background-color: #4f46e5; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #6b7280; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-tertiary { background-color: #dc2626; }
        .btn-tertiary:hover { background-color: #b91c1c; }
        .btn-tertiary:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .btn-quaternary { background-color: #f97316; }
        .btn-quaternary:hover { background-color: #ea580c; }
        .btn-quaternary:disabled { background-color: #fdba74; cursor: not-allowed; }
        .btn-quintenary { background-color: #10b981; }
        .btn-quintenary:hover { background-color: #059669; }
        .btn-sidenary { background-color: #8b5cf6; }
        .btn-sidenary:hover { background-color: #7c3aed; }
        .btn-heptanary { background-color: #0891b2; }
        .btn-heptanary:hover { background-color: #0e7490; }

        #image-container img, #detail-image-container img, #uploaded-image-preview, #i2i-generated-image, #lineart-upload-generated-image, #bg-generated-image {
            max-width: 100%; height: auto; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .modal { background-color: rgba(0, 0, 0, 0.5); }
        #notebook-toggle, #encyclopedia-toggle {
            position: absolute; top: 1rem; z-index: 20;
        }
        #notebook-toggle { right: 1rem; }
        #encyclopedia-toggle { left: 1rem; }

        .upload-zone { border: 2px dashed #cbd5e1; transition: all 0.2s ease; }
        .upload-zone:hover { border-color: #8b5cf6; background-color: #f5f3ff; }
        .upload-zone.has-image { border-color: #10b981; }

        .spinner {
            display: inline-block;
            animation: spin 1s linear infinite;
            border-radius: 50%;
            width: 2rem; /* 32px */
            height: 2rem; /* 32px */
            border-width: 4px;
            border-color: #d1d5db; /* gray-300 */
            border-top-color: #4f46e5; /* indigo-600 */
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        #notebook-panel {
            position: absolute;
            top: 4.5rem;
            right: 1rem;
        }

        #notebook-header {
            cursor: move;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="container mx-auto bg-white p-8 rounded-2xl shadow-2xl space-y-8">
        
        <!-- Global Elements (Visible on both pages) -->
        <div id="notebook-toggle" class="p-2 rounded-full hover:bg-gray-100 cursor-pointer" title="çµæ„Ÿç¬”è®°æœ¬">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
        </div>
        
        <div id="encyclopedia-toggle" class="p-2 rounded-full hover:bg-gray-100 cursor-pointer" title="æ—¶å°šç™¾ç§‘å…¨ä¹¦">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v11.494m-9-8.494h18m-18 5.494h18M5 21h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
        </div>

        <div id="notebook-panel" class="hidden w-72 bg-white/80 backdrop-blur-sm p-4 rounded-lg shadow-lg z-30">
            <div id="notebook-header" class="flex justify-between items-center pb-2 mb-2 border-b border-gray-200">
                 <h3 class="text-lg font-bold text-gray-800">çµæ„Ÿç¬”è®°æœ¬</h3>
                 <span class="text-gray-400" title="å¯æ‹–åŠ¨">âœ¥</span>
            </div>
            <textarea id="notebook-textarea" class="w-full h-48 p-2 border border-gray-200 rounded-md resize-none focus:ring-2 focus:ring-purple-400" placeholder="åœ¨è¿™é‡Œè®°å½•ä½ çš„çµæ„Ÿå…³é”®è¯..."></textarea>
            <div class="flex justify-between items-center mt-2">
                <span id="notebook-status" class="text-sm text-green-600 opacity-0 transition-opacity">å·²ä¿å­˜!</span>
                <div>
                    <button id="notebook-copy-btn" class="px-3 py-1 text-sm font-semibold text-white rounded-full btn btn-secondary">å¤åˆ¶</button>
                    <button id="notebook-clear-btn" class="px-3 py-1 text-sm font-semibold text-white rounded-full btn btn-tertiary">æ¸…ç©º</button>
                </div>
            </div>
        </div>

        <!-- PAGE 1: Main App -->
        <div id="main-page">
            <header class="text-center">
                <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800">AI æœé¥°è®¾è®¡åŠ©æ‰‹ ğŸ‘•</h1>
                <p class="mt-2 text-gray-600">è¾“å…¥ä½ çš„æœè£…è®¾è®¡æƒ³æ³•ï¼Œç”Ÿæˆä¸“ä¸šçš„è®¾è®¡å›¾å’Œè¯´æ˜ã€‚</p>
                <p class="mt-2 text-sm text-gray-500">API è°ƒç”¨æ¬¡æ•°ç”±åç«¯ç®¡ç†</p>
            </header>
            
            <div class="text-center">
                <button id="go-to-i2i" class="inline-block px-6 py-2 text-white font-bold rounded-full shadow-lg btn-heptanary">åˆ‡æ¢åˆ°å›¾ç”Ÿå›¾æ¨¡å¼ â†’</button>
            </div>

            <main class="space-y-4">
                <div>
                    <label for="prompt-input" class="block text-sm font-medium text-gray-700">
                        è¾“å…¥ä½ çš„æœè£…è®¾è®¡æƒ³æ³•ï¼š
                    </label>
                    <textarea id="prompt-input" rows="4" class="mt-1 block w-full rounded-lg border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500 transition-colors" placeholder="ä¾‹å¦‚: ä¸€ä»¶èµ›åšæœ‹å…‹é£æ ¼çš„æœªæ¥æ´¾å¤¹å…‹ï¼Œå¸¦æœ‰éœ“è™¹ç¯å¸¦ï¼Œç”±åå…‰é¢æ–™åˆ¶æˆ"></textarea>
                </div>
                
                <div class="grid grid-cols-2 sm:grid-cols-5 gap-3">
                    <button id="refine-btn" class="min-w-0 w-full px-4 py-3 border border-transparent rounded-full shadow-lg text-sm sm:text-base font-bold text-white btn btn-tertiary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        <span>çµæ„Ÿè¯åº“ ğŸ“š</span>
                    </button>
                     <button id="scripting-btn" class="min-w-0 w-full px-4 py-3 border border-transparent rounded-full shadow-lg text-sm sm:text-base font-bold text-white btn btn-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                        <span>åœºæ™¯æ­é… ğŸ­</span>
                    </button>

                    <div class="relative min-w-0">
                        <button id="generate-model-btn" class="w-full px-4 py-3 border border-transparent rounded-full shadow-lg text-sm sm:text-base font-bold text-white btn btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <span>ç”Ÿæˆæ¨¡ç‰¹ ğŸ§</span>
                        </button>
                        <div id="model-options" class="absolute top-full mt-2 w-56 bg-white rounded-md shadow-lg z-10 hidden origin-top-right right-0">
                            <div class="py-1">
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-model-style="sketch">æ‰‹ç»˜é£æ ¼</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-model-style="photo">AIæ‘„å½±å¸ˆ (çœŸå®æ•ˆæœ)</a>
                            </div>
                        </div>
                    </div>
                    
                    <button id="generate-btn" class="min-w-0 w-full px-4 py-3 border border-transparent rounded-full shadow-lg text-sm sm:text-base font-bold text-white btn btn-quaternary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500" disabled>
                        <span>ç”Ÿæˆè®¾è®¡å›¾ âœ¨</span>
                    </button>
                    <button id="lineart-btn" class="min-w-0 w-full px-4 py-3 border border-transparent rounded-full shadow-lg text-sm sm:text-base font-bold text-white btn btn-sidenary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                        <span>è®¾è®¡çº¿ç¨¿ âœ’ï¸</span>
                    </button>
                </div>

                <section id="result-container" class="space-y-4">
                    <div id="main-loading-container" class="text-center py-8 hidden">
                        <div class="spinner"></div>
                        <p class="mt-2 text-sm font-medium text-gray-600">æ­£åœ¨åŠ è½½...</p>
                    </div>

                    <div id="image-container" class="w-full h-auto flex justify-center items-center relative">
                        <img id="generated-image" class="hidden" alt="Generated AI Image">
                    </div>

                    <div id="model-modification-container" class="hidden text-center mt-4 space-y-3">
                        <button id="show-modify-model-input-btn" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn-heptanary">ä¿®æ”¹æ¨¡ç‰¹å›¾ ğŸ¨</button>
                        <div id="modify-model-input-area" class="hidden w-full max-w-lg mx-auto space-y-2">
                            <textarea id="modify-model-prompt" rows="2" class="w-full rounded-lg border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="ä¾‹å¦‚ï¼šç»™æ¨¡ç‰¹æ¢ä¸Šçº¢è‰²é•¿å‘ï¼Œç©¿ä¸Šçš®å¤¹å…‹"></textarea>
                            <button id="submit-model-modification-btn" class="w-full sm:w-auto px-6 py-2 text-white font-bold rounded-full shadow-lg btn-quintenary">ç”Ÿæˆä¿®æ”¹å›¾</button>
                        </div>
                    </div>
                    
                    <div id="detail-image-container" class="w-full h-auto flex justify-center items-center mt-4">
                        <div class="relative w-full">
                             <div id="detail-loading-container" class="text-center py-8 hidden">
                                <div class="spinner"></div>
                                <p class="mt-2 text-sm font-medium text-gray-600">æ­£åœ¨ç”Ÿæˆä¿®æ”¹å›¾...</p>
                            </div>
                            <img id="detail-image" class="hidden mx-auto" alt="Detailed AI Image">
                        </div>
                    </div>

                    <div id="story-buttons-container" class="flex flex-col space-y-2 mt-4 hidden">
                        <label for="story-prompt-input" class="block text-sm font-medium text-gray-700">
                            è®¾è®¡è¯´æ˜æŒ‡ä»¤ (å¯ç¼–è¾‘)ï¼š
                        </label>
                        <textarea id="story-prompt-input" rows="2" class="w-full rounded-lg border border-gray-300 shadow-sm p-3 story-prompt-textarea focus:border-indigo-500 focus:ring-indigo-500 transition-colors"></textarea>
                        <div class="flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-2 mt-4 relative">
                            <button id="story-btn" class="w-full sm:w-auto px-6 py-3 border border-transparent rounded-full shadow-lg text-base sm:text-lg font-bold text-white btn-tertiary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" disabled>
                                <span>ç”Ÿæˆè®¾è®¡è¯´æ˜ âœ¨</span>
                            </button>
                            <button id="detail-btn" class="w-full sm:w-auto px-6 py-3 border border-transparent rounded-full shadow-lg text-base sm:text-lg font-bold text-white btn-quintenary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" disabled>
                                <span>æ·±åŒ–è®¾è®¡ç»†èŠ‚ ğŸ”¬</span>
                            </button>
                            <div id="detail-options" class="absolute top-full mt-2 w-full sm:w-auto bg-white rounded-md shadow-lg z-10 hidden">
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 font-bold" data-detail-prompt="custom">æ›´å¤šç»†èŠ‚... (æ‰‹åŠ¨è¾“å…¥)</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Show a macro close-up of the fabric texture.">æ”¾å¤§é¢æ–™ç»†èŠ‚</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Show the back view of this garment.">å±•ç¤ºæœè£…èƒŒé¢</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Show the side profile of this garment.">å±•ç¤ºæœè£…ä¾§é¢</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="show-on-model">å±•ç¤ºæ¨¡ç‰¹ä¸Šèº«æ•ˆæœ</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Show this garment flat lay.">å±•ç¤ºæœè£…å¹³é“ºå›¾</a>
                            </div>
                        </div>
                    </div>

                    <div id="story-container" class="p-4 bg-gray-50 border border-dashed border-gray-300 rounded-lg hidden">
                        <p class="text-sm font-medium text-gray-700">è®¾è®¡è¯´æ˜ï¼š</p>
                        <p id="story-text" class="mt-1 text-gray-900 leading-relaxed whitespace-pre-wrap"></p>
                        <div id="story-action-buttons" class="flex justify-center mt-4 hidden">
                            <button id="copy-story-btn" class="px-6 py-2 text-sm font-bold text-white rounded-full shadow-lg btn-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                ä¸€é”®å¤åˆ¶
                            </button>
                        </div>
                    </div>

                    <div id="error-message" class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden">
                        <p id="error-text" class="text-sm font-medium"></p>
                    </div>
                </section>
            </main>
        </div>

        <!-- PAGE 2: Image-to-Image Studio -->
        <div id="i2i-page" class="hidden">
             <header class="text-center">
                <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800">å›¾ç”Ÿå›¾å·¥ä½œå®¤ ğŸ–¼ï¸</h1>
                <p class="mt-2 text-gray-600">ä¸Šä¼ æ¨¡ç‰¹ä¸æœè£…ï¼Œä¸€é”®ç”Ÿæˆç©¿æ­æ•ˆæœå›¾ã€‚</p>
            </header>
            <div class="text-center mt-4">
                <button id="go-to-main" class="inline-block px-6 py-2 text-white font-bold rounded-full shadow-lg btn-secondary">â† è¿”å›æ–‡æœ¬åˆ›ä½œæ¨¡å¼</button>
            </div>
            <section id="image-to-image-section" class="space-y-6 pt-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Model Upload -->
                    <div class="w-full">
                        <p class="text-center font-semibold text-gray-700 mb-2">1. ä¸Šä¼ æ¨¡ç‰¹å›¾</p>
                        <label for="i2i-model-upload-input" class="block text-center p-6 rounded-lg cursor-pointer upload-zone">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                            <span class="mt-2 block text-sm font-medium text-gray-600">ç‚¹å‡»ä¸Šä¼ æ¨¡ç‰¹</span>
                        </label>
                        <input type="file" id="i2i-model-upload-input" class="hidden" accept="image/*">
                        <div id="i2i-model-preview-container" class="hidden text-center mt-4">
                             <img id="i2i-model-preview" class="mx-auto" style="max-height: 200px; width: auto;" alt="Model Preview">
                        </div>
                    </div>
                     <!-- Garment Upload -->
                    <div class="w-full">
                        <p class="text-center font-semibold text-gray-700 mb-2">2. ä¸Šä¼ æœè£…å›¾</p>
                        <label for="i2i-garment-upload-input" class="block text-center p-6 rounded-lg cursor-pointer upload-zone">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                            <span class="mt-2 block text-sm font-medium text-gray-600">ç‚¹å‡»ä¸Šä¼ æœè£…</span>
                        </label>
                        <input type="file" id="i2i-garment-upload-input" class="hidden" accept="image/*">
                         <div id="i2i-garment-preview-container" class="hidden text-center mt-4">
                             <img id="i2i-garment-preview" class="mx-auto" style="max-height: 200px; width: auto;" alt="Garment Preview">
                        </div>
                    </div>
                </div>

                <div class="w-full max-w-md mx-auto space-y-4">
                    <button id="try-on-btn" class="w-full py-3 px-4 border border-transparent rounded-full shadow-lg text-base font-bold text-white btn btn-quintenary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" disabled>ä¸€é”®ç©¿æ­ ğŸ‘•</button>
                    
                    <div id="i2i-generated-image-container" class="hidden text-center">
                         <div class="space-y-6">
                            <div id="i2i-before-container" class="hidden w-full relative">
                                <img id="i2i-before-image" class="mx-auto rounded-lg shadow-md" alt="Original Try-on Image">
                            </div>
                            <div id="i2i-after-container" class="w-full relative">
                                <div id="i2i-loading-container" class="text-center py-8 hidden">
                                    <div class="spinner"></div>
                                    <p class="mt-2 text-sm font-medium text-gray-600">æ­£åœ¨åŠ è½½...</p>
                                </div>
                                <img id="i2i-generated-image" class="mx-auto rounded-lg shadow-md" alt="Generated Image">
                            </div>
                            <div id="i2i-modification-buttons" class="w-full flex flex-col items-center gap-2">
                                <button id="modify-try-on-btn" class="hidden w-full sm:w-auto px-6 py-3 border border-transparent rounded-full shadow-lg text-base font-bold text-white btn-heptanary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500">
                                    <span>ä¿®æ”¹æ•ˆæœå›¾ ğŸ¨</span>
                                </button>
                                <button id="generate-copy-btn" class="hidden w-full sm:w-auto px-6 py-3 border border-transparent rounded-full shadow-lg text-base font-bold text-white btn-sidenary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                                    <span>ç”Ÿæˆæ–‡æ¡ˆ âœï¸</span>
                                </button>
                            </div>
                            <div id="copy-display-container" class="hidden p-4 bg-gray-50 border border-dashed border-gray-300 rounded-lg text-left">
                                <div class="flex justify-between items-center mb-2">
                                     <p class="text-sm font-medium text-gray-700">ç”Ÿæˆæ–‡æ¡ˆï¼š</p>
                                     <button id="copy-generated-text-btn" class="px-3 py-1 text-sm font-semibold text-white rounded-full btn btn-secondary">å¤åˆ¶</button>
                                </div>
                                <p id="generated-copy-text" class="mt-1 text-gray-900 leading-relaxed whitespace-pre-wrap"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <hr class="my-8 border-t border-gray-200">

            <!-- New Section: Background Replacement -->
            <section id="background-replacement-section" class="space-y-6 pt-2">
                <header class="text-center">
                    <h2 class="text-2xl font-bold text-gray-800">äº§å“èƒŒæ™¯æ›´æ¢å·¥ä½œå®¤ ğŸï¸</h2>
                    <p class="mt-1 text-gray-500">ä¸Šä¼ äº§å“å›¾å’Œæ–°èƒŒæ™¯ï¼Œä¸€é”®åˆæˆè¥é”€å›¾ã€‚</p>
                </header>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Garment Upload for BG Change -->
                    <div class="w-full">
                        <p class="text-center font-semibold text-gray-700 mb-2">1. ä¸Šä¼ äº§å“å›¾</p>
                        <label for="bg-garment-upload-input" class="block text-center p-6 rounded-lg cursor-pointer upload-zone">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                            <span class="mt-2 block text-sm font-medium text-gray-600">ç‚¹å‡»ä¸Šä¼ äº§å“</span>
                        </label>
                        <input type="file" id="bg-garment-upload-input" class="hidden" accept="image/*">
                        <div id="bg-garment-preview-container" class="hidden text-center mt-4">
                             <img id="bg-garment-preview" class="mx-auto" style="max-height: 200px; width: auto;" alt="Product Preview">
                        </div>
                    </div>
                     <!-- Background Upload -->
                    <div class="w-full">
                        <p class="text-center font-semibold text-gray-700 mb-2">2. ä¸Šä¼ èƒŒæ™¯å›¾</p>
                        <label for="bg-background-upload-input" class="block text-center p-6 rounded-lg cursor-pointer upload-zone">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                            <span class="mt-2 block text-sm font-medium text-gray-600">ç‚¹å‡»ä¸Šä¼ èƒŒæ™¯</span>
                        </label>
                        <input type="file" id="bg-background-upload-input" class="hidden" accept="image/*">
                         <div id="bg-background-preview-container" class="hidden text-center mt-4">
                             <img id="bg-background-preview" class="mx-auto" style="max-height: 200px; width: auto;" alt="Background Preview">
                        </div>
                    </div>
                </div>

                <div class="w-full max-w-md mx-auto space-y-4">
                    <button id="change-bg-btn" class="w-full py-3 px-4 border border-transparent rounded-full shadow-lg text-base font-bold text-white btn btn-heptanary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500" disabled>æ›´æ¢èƒŒæ™¯ ğŸ–¼ï¸</button>
                    
                    <div id="bg-generated-image-container" class="hidden text-center">
                         <div class="space-y-6">
                            <div id="bg-after-container" class="w-full relative">
                                <div id="bg-loading-container" class="text-center py-8 hidden">
                                    <div class="spinner"></div>
                                    <p class="mt-2 text-sm font-medium text-gray-600">æ­£åœ¨åŠ è½½...</p>
                                </div>
                                <img id="bg-generated-image" class="mx-auto rounded-lg shadow-md" alt="Generated Image with New Background">
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        
        <!-- MODALS -->
        <div id="vocab-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-2xl bg-white space-y-6">
                <div class="flex justify-between items-center pb-3">
                    <h3 class="text-2xl font-bold text-gray-900">æœé¥°è®¾è®¡çµæ„Ÿè¯åº“</h3>
                    <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                </div>
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-gray-700 cursor-pointer hover:text-indigo-600 transition-colors" data-target="style-type-buttons">æ¬¾å¼ç±»åˆ« (Garment Type)</h4>
                    <div id="style-type-buttons" class="flex flex-wrap gap-2 hidden"></div>
                </div>
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-gray-700 cursor-pointer hover:text-indigo-600 transition-colors" data-target="aesthetic-buttons">è®¾è®¡é£æ ¼ (Aesthetic)</h4>
                    <div id="aesthetic-buttons" class="flex flex-wrap gap-2 hidden"></div>
                </div>
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-gray-700 cursor-pointer hover:text-indigo-600 transition-colors" data-target="material-buttons">é¢æ–™æè´¨ (Material)</h4>
                    <div id="material-buttons" class="flex flex-wrap gap-2 hidden"></div>
                </div>
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-gray-700 cursor-pointer hover:text-indigo-600 transition-colors" data-target="pattern-buttons">å›¾æ¡ˆå°èŠ± (Pattern/Print)</h4>
                    <div id="pattern-buttons" class="flex flex-wrap gap-2 hidden"></div>
                </div>
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-gray-700 cursor-pointer hover:text-indigo-600 transition-colors" data-target="details-buttons">ç»†èŠ‚å‰ªè£ (Details/Cut)</h4>
                    <div id="details-buttons" class="flex flex-wrap gap-2 hidden"></div>
                </div>
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-gray-700 cursor-pointer hover:text-indigo-600 transition-colors" data-target="color-buttons">è‰²å½©æ­é… (Color)</h4>
                    <div id="color-buttons" class="flex flex-wrap gap-2 hidden"></div>
                </div>
            </div>
        </div>

        <div id="custom-detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-2xl bg-white space-y-4">
                <div class="flex justify-between items-center"> <h3 class="text-xl font-bold text-gray-900">è¾“å…¥è‡ªå®šä¹‰ä¿®æ”¹æŒ‡ä»¤</h3> <button id="close-custom-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button> </div>
                <div> <textarea id="custom-detail-input" rows="3" class="w-full rounded-lg border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="ä¾‹å¦‚ï¼šç»™è¿™ä»¶å¤¹å…‹åŠ ä¸Šå…œå¸½"></textarea> </div>
                <div class="flex justify-end"> <button id="submit-custom-detail" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn-quintenary">ç”Ÿæˆç»†èŠ‚å›¾</button> </div>
            </div>
        </div>
        
        <div id="custom-model-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-2xl bg-white space-y-4">
                <div class="flex justify-between items-center">
                    <h3 id="custom-model-title" class="text-xl font-bold text-gray-900">è¾“å…¥è‡ªå®šä¹‰æ¨¡ç‰¹ç‰¹å¾</h3>
                    <button id="close-custom-model-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                </div>
                <div>
                    <textarea id="custom-model-input" rows="3" class="w-full rounded-lg border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="ä¾‹å¦‚ï¼š25å²äºšæ´²ç”·æ€§ï¼Œèº«æå¥ç¡•ï¼Œæ·±è‰²çš®è‚¤ï¼Œèº«é«˜185cmï¼Œå†™å®ç…§ç‰‡é£æ ¼"></textarea>
                </div>
                <div class="flex justify-end">
                    <button id="submit-custom-model" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn-primary">ç”Ÿæˆæ¨¡ç‰¹</button>
                </div>
            </div>
        </div>
        
        <div id="modify-try-on-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-2xl bg-white space-y-4">
                <div class="flex justify-between items-center"> <h3 class="text-xl font-bold text-gray-900">è¾“å…¥ä¿®æ”¹æŒ‡ä»¤</h3> <button id="close-modify-try-on-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button> </div>
                <div> <textarea id="modify-try-on-input" rows="3" class="w-full rounded-lg border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="ä¾‹å¦‚ï¼šå°†èƒŒæ™¯æ¢æˆè¡—é“ï¼Œå±•ç¤ºä¾§é¢æ•ˆæœ"></textarea> </div>
                <div class="flex justify-end"> <button id="submit-modify-try-on" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn-heptanary">ç¡®è®¤ä¿®æ”¹</button> </div>
            </div>
        </div>
        
        <div id="generate-copy-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-2xl bg-white space-y-4">
                <div class="flex justify-between items-center">
                     <h3 class="text-xl font-bold text-gray-900">ç”Ÿæˆæ¨å¹¿æ–‡æ¡ˆ</h3>
                     <button id="close-generate-copy-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                </div>
                <div>
                     <label for="generate-copy-input" class="block text-sm font-medium text-gray-700 mb-1">æ–‡æ¡ˆè¦æ±‚ (é€‰å¡«)</label>
                     <textarea id="generate-copy-input" rows="3" class="w-full rounded-lg border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="ä¾‹å¦‚ï¼šå°çº¢ä¹¦é£æ ¼ï¼Œçªå‡ºå°‘å¥³æ„Ÿå’Œå¤æ—¥æ¸…å‡‰"></textarea>
                </div>
                <div class="flex justify-end">
                     <button id="submit-generate-copy" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn-sidenary">ç”Ÿæˆæ–‡æ¡ˆ</button>
                </div>
            </div>
        </div>

        <div id="i2i-custom-detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-2xl bg-white space-y-4">
                <div class="flex justify-between items-center"> <h3 class="text-xl font-bold text-gray-900">è¾“å…¥è‡ªå®šä¹‰ä¿®æ”¹æŒ‡ä»¤</h3> <button id="i2i-close-custom-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button> </div>
                <div> <textarea id="i2i-custom-detail-input" rows="3" class="w-full rounded-lg border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="ä¾‹å¦‚ï¼šæŠŠè¿™ä»¶Tæ¤çš„é¢œè‰²æ”¹æˆé»‘è‰²"></textarea> </div>
                <div class="flex justify-end"> <button id="i2i-submit-custom-detail" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn-quintenary">ç”Ÿæˆç»†èŠ‚å›¾</button> </div>
            </div>
        </div>

        <div id="lineart-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
             <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-2xl bg-white space-y-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold text-gray-900">è®¾è®¡çº¿ç¨¿ç”Ÿæˆå™¨ âœ’ï¸</h3>
                    <button id="close-lineart-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                </div>
                
                <div class="p-4 border-b border-gray-200">
                    <h4 class="text-xl font-semibold mb-2 text-center">ä»æ–‡æœ¬ç”Ÿæˆçº¿ç¨¿</h4>
                    <div class="flex space-x-2">
                        <input type="text" id="lineart-input" class="flex-grow rounded-full border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="è¾“å…¥è®¾è®¡ä¸»é¢˜ï¼Œä¾‹å¦‚ï¼šä¸€ä»¶è¿è¡£è£™">
                        <button id="lineart-generate-btn" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn-sidenary">ç”Ÿæˆçº¿ç¨¿</button>
                    </div>
                </div>
                
                <div id="lineart-loading-container" class="text-center py-8 hidden">
                    <div class="spinner"></div>
                    <p class="mt-2 text-sm font-medium text-gray-600">æ­£åœ¨ç”Ÿæˆçº¿ç¨¿...</p>
                </div>

                <div id="lineart-results" class="space-y-4 p-2 text-center">
                </div>

                <hr class="my-4">

                <div class="p-4">
                    <h4 class="text-xl font-semibold mb-2 text-center">ä¸Šä¼ å›¾ç‰‡å†åˆ›ä½œ</h4>
                     <div class="w-full max-w-md mx-auto">
                        <label for="lineart-upload-input" class="block text-center p-6 rounded-lg cursor-pointer upload-zone">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                            <span class="mt-2 block text-sm font-medium text-gray-600">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</span>
                        </label>
                        <input type="file" id="lineart-upload-input" class="hidden" accept="image/*">
                        <div id="lineart-upload-preview-container" class="hidden text-center mt-4">
                             <img id="lineart-upload-preview" class="mx-auto rounded-lg shadow-md" alt="Uploaded Image Preview">
                        </div>
                        <div id="lineart-upload-modification-container" class="hidden w-full max-w-md mx-auto mt-4 space-y-3">
                            <label for="lineart-upload-modification-prompt" class="block text-sm font-medium text-gray-700">å¯åœ¨æ­¤å¤„æè¿°æœŸæœ›çš„çœŸäººæ¨¡ç‰¹ç‰¹å¾ (é€‰å¡«):</label>
                            <textarea id="lineart-upload-modification-prompt" rows="3" class="w-full rounded-lg border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="ä¾‹å¦‚ï¼šæ¢æˆäºšæ´²æ¨¡ç‰¹ã€èƒŒæ™¯åœ¨ä¸œäº¬è¡—å¤´ã€æ”¹ä¸ºçŸ­å‘ç­‰"></textarea>
                            <button id="lineart-upload-modify-btn" class="w-full py-2 px-4 border border-transparent rounded-full shadow-lg text-base font-bold text-white btn-heptanary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500">åˆ›æ„ä¿®æ”¹</button>
                            <button id="illustration-to-photo-btn" class="w-full py-3 px-4 border border-transparent rounded-full shadow-lg text-base font-bold text-white btn-quintenary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                <span class="flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" />
                                    </svg>
                                    ä¸€é”®è½¬ä¸ºçœŸäººæ•ˆæœ
                                </span>
                            </button>
                        </div>
                         <div id="lineart-upload-loading-container" class="text-center py-8 hidden">
                            <div class="spinner"></div>
                            <p class="mt-2 text-sm font-medium text-gray-600">æ­£åœ¨ç”Ÿæˆæ–°å›¾ç‰‡...</p>
                        </div>
                        <div id="lineart-upload-generated-image-container" class="hidden text-center mt-6 relative">
                            <img id="lineart-upload-generated-image" class="mx-auto rounded-lg shadow-md" alt="Generated Image from Upload">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="lineart-custom-detail-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-2xl bg-white space-y-4">
                <div class="flex justify-between items-center"> <h3 class="text-xl font-bold text-gray-900">è¾“å…¥è‡ªå®šä¹‰ä¿®æ”¹æŒ‡ä»¤</h3> <button id="lineart-close-custom-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button> </div>
                <div> <textarea id="lineart-custom-detail-input" rows="3" class="w-full rounded-lg border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="ä¾‹å¦‚ï¼šç»™è¿™ä»¶è¡£æœä¸Šè‰²"></textarea> </div>
                <div class="flex justify-end"> <button id="lineart-submit-custom-detail" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn-quintenary">ç”Ÿæˆ</button> </div>
            </div>
        </div>
        
        <div id="encyclopedia-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-2xl bg-white space-y-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold text-gray-900">æ—¶å°šç™¾ç§‘å…¨ä¹¦ ğŸ“–</h3>
                    <button id="close-encyclopedia-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                </div>
                <div class="flex space-x-2">
                    <input type="text" id="encyclopedia-input" class="flex-grow rounded-full border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500" placeholder="è¾“å…¥å…³é”®è¯æœç´¢ï¼Œä¾‹å¦‚ï¼šé¦™å¥ˆå„¿">
                    <button id="encyclopedia-search-btn" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn-primary">æœç´¢</button>
                </div>
                <div id="encyclopedia-loading" class="text-center py-4 hidden">
                    <div class="spinner"></div>
                    <p class="mt-2 text-sm font-medium text-blue-600">æ­£åœ¨æ£€ç´¢ä¿¡æ¯åº“...</p>
                </div>
                <div id="encyclopedia-results" class="space-y-4 max-h-[60vh] overflow-y-auto p-2">
                </div>
            </div>
        </div>

        <!-- Scene Styling Modal -->
        <div id="scripting-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-2xl bg-white space-y-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold text-gray-900">åœºæ™¯æœè£…æ­é…åŠ©æ‰‹ ğŸ­</h3>
                    <button id="close-scripting-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                </div>
                <div class="p-4 border-b border-gray-200 space-y-4">
                    <div>
                        <label for="script-input" class="block text-sm font-medium text-gray-700">è¾“å…¥åœºæ™¯ã€æ°›å›´æˆ–äººç‰©é£æ ¼ï¼š</label>
                        <textarea id="script-input" rows="6" class="mt-1 block w-full rounded-lg border border-gray-300 shadow-sm p-3 focus:border-indigo-500 focus:ring-indigo-500 transition-colors" placeholder="ä¾‹å¦‚ï¼šåœ¨ä¸‹é›¨çš„ä¸œäº¬è¡—å¤´ï¼Œä¸€ä¸ªå­¤ç‹¬çš„å¥³å­©..."></textarea>
                    </div>
                    <div class="space-y-2">
                        <p class="text-sm font-medium text-gray-600">é€‰æ‹©ä¸€ç§é£æ ¼å¿«é€Ÿå¼€å§‹ï¼š</p>
                        <div id="default-style-buttons" class="flex flex-wrap gap-2">
                             <button class="px-4 py-2 text-sm font-medium rounded-full bg-gray-100 hover:bg-indigo-100 text-gray-700 hover:text-indigo-700 transition-colors" data-style="ç›ç³»ï¼šæ¸…æ·¡ã€ç®€çº¦ã€ä¸­æ€§çš„ç‰¹ç‚¹ã€‚éšæ€§è€Œä¸éšä¾¿çš„èˆ’é€‚æ„Ÿ ï¼Œå…¶ä»£è¡¨æ€§çš„æœé¥°ï¼ˆå¦‚çº¯è‰²è¡¬è¡«ã€å®½æ¾è£¤è£…ã€ åŸºç¡€æ¬¾é’ˆç»‡è¡«ã€ç‰›ä»”è£¤ã€ç²¾è‡´å°é…é¥°ï¼‰ã€‚é…è‰²ï¼ˆä½é¥±å’Œåº¦å¤§åœ°è‰²ã€ç™½è‰²ã€ç±³ç™½ã€æ·¡è‰²ç³»ï¼‰ã€‚æ°”è´¨ï¼ˆæ¸…çˆ½ã€æ·¡å®šã€çŸ¥æ€§ã€å¹²å‡€ã€ç–ç¦»æ„Ÿï¼‰ã€‚">ç›ç³»</button>
                             <button class="px-4 py-2 text-sm font-medium rounded-full bg-gray-100 hover:bg-indigo-100 text-gray-700 hover:text-indigo-700 transition-colors" data-style="ç³–ç³»: æè‡´çš„ç”œç¾ã€æµªæ¼«ä¸è¶…å¥³æ€§åŒ–ç‰¹ç‚¹ã€‚å…¶ä»£è¡¨å…ƒç´ ï¼ˆå¦‚è•¾ä¸ã€è´è¶ç»“ã€ç¢èŠ±ã€æœ¨è€³è¾¹ ã€è·å¶è¾¹ã€é€çº±ã€é›ªçººã€æŸ”è½¯é’ˆç»‡ï¼‰ã€‚é…è‰²ï¼ˆç²‰å½©è‰²ç³»ã€å¥¶æ²¹é»„ã€ç„¦ç³–è‰²ç­‰ä½é¥±å’Œæš–è‰²ï¼‰ã€‚å¦†å®¹ç‰¹ç‚¹ï¼ˆå¦‚æ— è¾œçœ¼å¦†ã€ç²‰è‰²è…®çº¢ï¼‰ã€‚å½¢è±¡ï¼ˆç”œç¾ã€æµªæ¼«ã€çº¯çœŸã€å¯çˆ±ã€å°‘å¥³æ„Ÿï¼‰ã€‚">ç³–ç³»</button>
                             <button class="px-4 py-2 text-sm font-medium rounded-full bg-gray-100 hover:bg-indigo-100 text-gray-700 hover:text-indigo-700 transition-colors" data-style="çŒ«ç³»: ç‹¬ç«‹ã€è‡ªä¿¡ã€ç¥ç§˜ä¸”å¸¦æœ‰â€œå‚²å¨‡â€æ°”è´¨çš„ä¸ªäººä¸»ä¹‰ã€‚å…¶ç©¿æ­ä½“å–œæ¬¢è´¨æ„Ÿè‰¯å¥½ã€å‰ªè£ç²¾è‰¯çš„é¢æ–™ï¼Œä¾‹å¦‚æ…µæ‡’æ„Ÿçš„é’ˆç»‡è¡«æˆ–å±•ç°èº«ææ›²çº¿çš„å•å“ï¼Œä¸è¿‡åˆ†ç´§ç»·ï¼Œæ— ç‰¹å®šè‰²ç³»ã€‚ä¸Šæ‰¬çš„çœ¼çº¿å’Œç‹¬ç‰¹çš„é…é¥° ã€‚å¼ºè°ƒä¸ªäººå“å‘³ä¸æ•´ä½“å’Œè°ã€‚">çŒ«ç³»</button>
                             <button class="px-4 py-2 text-sm font-medium rounded-full bg-gray-100 hover:bg-indigo-100 text-gray-700 hover:text-indigo-700 transition-colors" data-style="æ£®ç³»: å¦‚ç”Ÿæ´»åœ¨æ£®æ—ä¸­ï¼Œè¿½æ±‚è‡ªç„¶ã€èˆ’é€‚ä¸æµªæ¼«çš„ç”°å›­å¹»æƒ³é£æ ¼ã€‚æœé¥°ç‰¹å¾ï¼ˆæ£‰éº»æè´¨ã€å¤©ç„¶ã€äº²è‚¤é¢æ–™ ã€å®½æ¾ã€é£˜é€¸å¤šå±‚æ¬¡å ç©¿ï¼Œæ¯”å¦‚ï¼šAå­—è¿è¡£è£™ã€é•¿åŠè£™ã€é’ˆç»‡å¼€è¡«ã€å¤å¤ç¢èŠ±ç­‰ï¼‰ã€‚é…è‰²ï¼ˆå¤§åœ°è‰²ç³»ã€æ¤ç‰©è‰²ç³»ã€æŸ”å’Œæš–è‰²ï¼‰ã€‚é…é¥°ï¼ˆæ‰‹å·¥æ„Ÿã€è‡ªç„¶å…ƒç´ ï¼‰ã€‚æ€§æ ¼ï¼ˆæ¸©æŸ”ã€ä¸ä¸–æ— äº‰ã€æ¸…æ–°ã€æ…µæ‡’ã€å´‡å°šè‡ªç„¶ï¼‰ã€‚">æ£®ç³»</button>
                             <button class="px-4 py-2 text-sm font-medium rounded-full bg-gray-100 hover:bg-indigo-100 text-gray-700 hover:text-indigo-700 transition-colors" data-style="å±±ç³»: æ´»åŠ›ã€ä¸“ä¸šã€å®ç”¨ã€çƒ­çˆ±æ¢ç´¢ã€‚å°†æˆ·å¤–åŠŸèƒ½æ€§æœè£…ï¼ˆå¦‚å†²é”‹è¡£ã€ç™»å±±é´ã€leggingsï¼‰èå…¥æ—¥å¸¸æ—¶å°šï¼Œå½¢æˆå…¼å…·å®ç”¨ä¸æ½®æµæ„Ÿçš„é£æ ¼ã€‚è‰²å½©ä¸Šé€šå¸¸æ›´é²œè‰³æ´»æ³¼ã€‚GORE-TEXã€CORDURAç­‰é«˜ç§‘æŠ€åŠŸèƒ½æ€§é¢æ–™ï¼Œä¸ºè¿åŠ¨è€Œè®¾è®¡çš„å®ç”¨å‹æœé¥°ï¼Œå¼ºè°ƒæŠ€æœ¯æ€§å ç©¿ï¼Œå•å“ï¼šå†²é”‹è¡£ã€æŠ“ç»’ã€ç™»å±±é‹ã€åŠŸèƒ½æ€§èƒŒåŒ…ç­‰ã€‚">å±±ç³»</button>
                             <button class="px-4 py-2 text-sm font-medium rounded-full bg-gray-100 hover:bg-indigo-100 text-gray-700 hover:text-indigo-700 transition-colors" data-style="åŸå®¿: åˆ›é€ æ€§ã€åå›ã€ä¸æ‹˜ä¸€æ ¼ï¼Œæè‡´çš„è‡ªæˆ‘è¡¨è¾¾ï¼Œå„ç§å‰å«äºšæ–‡åŒ–çš„åŠ¨æ€é›†åˆä½“ã€‚å®ƒå¹¶éå•ä¸€é£æ ¼ï¼Œè€Œæ˜¯å¤šç§æç«¯ã€ä¸ªæ€§åŒ–è¡—å¤´æ—¶å°šçš„æ€»ç§°ã€‚å…¶ä¸‹å±çš„å‡ ä¸ªé‡è¦åˆ†æ”¯ï¼Œå¦‚Decoraï¼ˆå¯çˆ±æœ€å¤§ä¸»ä¹‰ï¼Œé€šè¿‡æµ·é‡é…é¥°è¿›è¡Œè£…é¥°ï¼‰ã€Lolitaï¼ˆæºäºç»´å¤šåˆ©äºšä¸æ´›å¯å¯ç¾å­¦çš„æ´‹å¨ƒå¨ƒå¼ä¼˜é›…ä¸å¯çˆ±ï¼‰ã€Visual Keiï¼ˆä¸éŸ³ä¹ç´§å¯†ç»“åˆçš„ã€æˆå‰§åŒ–ä¸”é›Œé›„åŒä½“çš„è§†è§‰è¡¨æ¼”ï¼‰ç­‰ï¼Œå¤šæ ·æ€§æœé¥°é£æ ¼å¤šå˜ï¼Œä»æç¹åˆ°ç»“æ„åŒ–ã€‚æ··æ­ã€DIYã€æŒ‘æˆ˜å¸¸è§„ã€‚">åŸå®¿</button>
                             <button class="px-4 py-2 text-sm font-medium rounded-full bg-gray-100 hover:bg-indigo-100 text-gray-700 hover:text-indigo-700 transition-colors" data-style="O-phero: ä½œä¸ºä¸€ç§å¦†å®¹å’Œæ°›å›´æ„Ÿçš„æ½®æµï¼Œè¯±äººã€çº¯çœŸã€æ…µæ‡’ã€äº²å’Œã€‚â€œO-pheroâ€ä¸€è¯çš„æ¥æºï¼ˆOshare + Pheromoneï¼‰ï¼Œå…¶æ ¸å¿ƒå¦†å®¹ç‰¹ç‚¹ï¼ˆå¦‚å®¿é†‰å¦†ã€è¡€è‰²æ„Ÿè…®çº¢ã€æ°´æ¶¦å…‰æ³½è‚Œã€æ¹¿å‘æ„Ÿç­‰æ€§æ„Ÿçš„å¦†å®¹ï¼‰">O-phero</button>
                             <button class="px-4 py-2 text-sm font-medium rounded-full bg-gray-100 hover:bg-indigo-100 text-gray-700 hover:text-indigo-700 transition-colors" data-style="Y2K: ä¹è§‚ã€æ´»åŠ›ã€æœªæ¥æ„Ÿã€å¤§èƒ†ã€æœ‰è¶£ã€‚æºäº2000å¹´å‰åï¼Œå¹¶åœ¨å½“ä¸‹å¤å…´çš„å…¨çƒæ€§æ½®æµã€‚æ ‡å¿—æ€§å…ƒç´ ï¼ˆå¦‚ä½è…°è£¤ã€çŸ­æ¬¾ä¸Šè¡£ã€åšåº•é‹ã€æ³•æ£åŒ…ã€è´è¶å›¾æ¡ˆï¼‰ã€‚ä¸¹å®ã€é‡‘å±æ„Ÿé¢æ–™ã€PVCã€é—ªå…‰æè´¨ã€‚é…è‰²ï¼ˆé²œè‰³è‰²å½©ã€äº®è‰²ã€éœ“è™¹è‰²ã€é‡‘å±è‰²ã€ç²‰å½©è‰²ï¼‰ ã€‚">Y2K</button>
                        </div>
                    </div>
                    <div class="space-y-2">
                         <p class="text-sm font-medium text-gray-600">æ­é…è‰²ç³»ï¼š</p>
                         <div id="color-palette-buttons" class="flex flex-wrap gap-2">
                            <button class="px-4 py-2 text-sm font-medium rounded-full bg-gray-100 hover:bg-indigo-100 text-gray-700 hover:text-indigo-700 transition-colors">å¤§åœ°è‰²</button>
                            <button class="px-4 py-2 text-sm font-medium rounded-full bg-gray-100 hover:bg-indigo-100 text-gray-700 hover:text-indigo-700 transition-colors">è«å…°è¿ª</button>
                            <button class="px-4 py-2 text-sm font-medium rounded-full bg-gray-100 hover:bg-indigo-100 text-gray-700 hover:text-indigo-700 transition-colors">é»‘ç™½ç°</button>
                            <button class="px-4 py-2 text-sm font-medium rounded-full bg-gray-100 hover:bg-indigo-100 text-gray-700 hover:text-indigo-700 transition-colors">å¤šå·´èƒº</button>
                            <button class="px-4 py-2 text-sm font-medium rounded-full bg-gray-100 hover:bg-indigo-100 text-gray-700 hover:text-indigo-700 transition-colors">éœ“è™¹è‰²</button>
                            <button class="px-4 py-2 text-sm font-medium rounded-full bg-gray-100 hover:bg-indigo-100 text-gray-700 hover:text-indigo-700 transition-colors">ç²‰å½©è‰²</button>
                         </div>
                    </div>
                </div>
                 <div class="text-center">
                    <button id="generate-scripting-btn" class="px-8 py-3 text-white font-bold rounded-full shadow-lg btn-primary">ç”Ÿæˆæ­é…å»ºè®®</button>
                </div>
                <div id="scripting-loading" class="text-center py-8 hidden">
                    <div class="spinner"></div>
                    <p class="mt-2 text-sm font-medium text-gray-600">AIé€ å‹å¸ˆæ­£åœ¨æ„æ€ä¸­...</p>
                </div>
                <div id="scripting-results" class="space-y-4 p-2">
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- API & State Management ---
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent`;
        const IMAGE_GENERATION_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent`;
        
        // --- DOM Elements ---
        const apiUsageCounter = document.getElementById('api-usage-counter');
        const mainPage = document.getElementById('main-page');
        const i2iPage = document.getElementById('i2i-page');
        const promptInput = document.getElementById('prompt-input');
        const refineBtn = document.getElementById('refine-btn');
        const generateBtn = document.getElementById('generate-btn');
        const storyBtn = document.getElementById('story-btn');
        const detailBtn = document.getElementById('detail-btn');
        const detailOptions = document.getElementById('detail-options');
        const imageContainer = document.getElementById('image-container');
        const generatedImage = document.getElementById('generated-image');
        const detailImageContainer = document.getElementById('detail-image-container');
        const detailImage = document.getElementById('detail-image');
        const storyContainer = document.getElementById('story-container');
        const storyButtonsContainer = document.getElementById('story-buttons-container');
        const storyText = document.getElementById('story-text');
        const storyPromptInput = document.getElementById('story-prompt-input');
        const copyStoryBtn = document.getElementById('copy-story-btn');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const vocabModal = document.getElementById('vocab-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const customDetailModal = document.getElementById('custom-detail-modal');
        const closeCustomModalBtn = document.getElementById('close-custom-modal-btn');
        const customDetailInput = document.getElementById('custom-detail-input');
        const submitCustomDetailBtn = document.getElementById('submit-custom-detail');
        const encyclopediaModal = document.getElementById('encyclopedia-modal');
        const encyclopediaToggle = document.getElementById('encyclopedia-toggle');
        const closeEncyclopediaModalBtn = document.getElementById('close-encyclopedia-modal-btn');
        const encyclopediaInput = document.getElementById('encyclopedia-input');
        const encyclopediaSearchBtn = document.getElementById('encyclopedia-search-btn');
        const encyclopediaResults = document.getElementById('encyclopedia-results');
        const lineartModal = document.getElementById('lineart-modal');
        const lineartBtn = document.getElementById('lineart-btn');
        const closeLineartModalBtn = document.getElementById('close-lineart-modal-btn');
        const lineartInput = document.getElementById('lineart-input');
        const lineartGenerateBtn = document.getElementById('lineart-generate-btn');
        const lineartResults = document.getElementById('lineart-results');
        const lineartCustomDetailModal = document.getElementById('lineart-custom-detail-modal');
        const lineartCloseCustomModalBtn = document.getElementById('lineart-close-custom-modal-btn');
        const lineartCustomDetailInput = document.getElementById('lineart-custom-detail-input');
        const lineartSubmitCustomDetailBtn = document.getElementById('lineart-submit-custom-detail');
        const lineartUploadInput = document.getElementById('lineart-upload-input');
        const lineartUploadPreviewContainer = document.getElementById('lineart-upload-preview-container');
        const lineartUploadPreview = document.getElementById('lineart-upload-preview');
        const lineartUploadModificationContainer = document.getElementById('lineart-upload-modification-container');
        const lineartUploadModificationPrompt = document.getElementById('lineart-upload-modification-prompt');
        const lineartUploadModifyBtn = document.getElementById('lineart-upload-modify-btn');
        const illustrationToPhotoBtn = document.getElementById('illustration-to-photo-btn');
        const lineartUploadGeneratedImageContainer = document.getElementById('lineart-upload-generated-image-container');
        const lineartUploadGeneratedImage = document.getElementById('lineart-upload-generated-image');
        const notebookToggle = document.getElementById('notebook-toggle');
        const notebookPanel = document.getElementById('notebook-panel');
        const notebookTextarea = document.getElementById('notebook-textarea');
        const notebookStatus = document.getElementById('notebook-status');
        const notebookCopyBtn = document.getElementById('notebook-copy-btn');
        const notebookClearBtn = document.getElementById('notebook-clear-btn');
        const notebookHeader = document.getElementById('notebook-header');
        const generateModelBtn = document.getElementById('generate-model-btn');
        const modelOptions = document.getElementById('model-options');
        const customModelModal = document.getElementById('custom-model-modal');
        const closeCustomModelBtn = document.getElementById('close-custom-model-btn');
        const customModelInput = document.getElementById('custom-model-input');
        const submitCustomModelBtn = document.getElementById('submit-custom-model');
        const modelModificationContainer = document.getElementById('model-modification-container');
        const showModifyModelInputBtn = document.getElementById('show-modify-model-input-btn');
        const modifyModelInputArea = document.getElementById('modify-model-input-area');
        const modifyModelPrompt = document.getElementById('modify-model-prompt');
        const submitModelModificationBtn = document.getElementById('submit-model-modification-btn');
        const i2iModelUploadInput = document.getElementById('i2i-model-upload-input');
        const i2iGarmentUploadInput = document.getElementById('i2i-garment-upload-input');
        const i2iModelPreviewContainer = document.getElementById('i2i-model-preview-container');
        const i2iModelPreview = document.getElementById('i2i-model-preview');
        const i2iGarmentPreviewContainer = document.getElementById('i2i-garment-preview-container');
        const i2iGarmentPreview = document.getElementById('i2i-garment-preview');
        const tryOnBtn = document.getElementById('try-on-btn');
        const modifyTryOnBtn = document.getElementById('modify-try-on-btn');
        const generateCopyBtn = document.getElementById('generate-copy-btn');
        const modifyTryOnModal = document.getElementById('modify-try-on-modal');
        const closeModifyTryOnModalBtn = document.getElementById('close-modify-try-on-modal-btn');
        const modifyTryOnInput = document.getElementById('modify-try-on-input');
        const submitModifyTryOnBtn = document.getElementById('submit-modify-try-on');
        const i2iGeneratedImageContainer = document.getElementById('i2i-generated-image-container');
        const i2iBeforeContainer = document.getElementById('i2i-before-container');
        const i2iBeforeImage = document.getElementById('i2i-before-image');
        const i2iAfterContainer = document.getElementById('i2i-after-container');
        const i2iGeneratedImage = document.getElementById('i2i-generated-image');
        const i2iCustomDetailModal = document.getElementById('i2i-custom-detail-modal');
        const i2iCloseCustomModalBtn = document.getElementById('i2i-close-custom-modal-btn');
        const i2iCustomDetailInput = document.getElementById('i2i-custom-detail-input');
        const i2iSubmitCustomDetailBtn = document.getElementById('i2i-submit-custom-detail');
        const generateCopyModal = document.getElementById('generate-copy-modal');
        const closeGenerateCopyModalBtn = document.getElementById('close-generate-copy-modal-btn');
        const generateCopyInput = document.getElementById('generate-copy-input');
        const submitGenerateCopyBtn = document.getElementById('submit-generate-copy');
        const copyDisplayContainer = document.getElementById('copy-display-container');
        const generatedCopyText = document.getElementById('generated-copy-text');
        const copyGeneratedTextBtn = document.getElementById('copy-generated-text-btn');
        const goToI2IButton = document.getElementById('go-to-i2i');
        const goToMainButton = document.getElementById('go-to-main');
        const appContainer = document.getElementById('app-container');
        const customModelTitle = document.getElementById('custom-model-title');
        const changeBgBtn = document.getElementById('change-bg-btn');
        const bgGarmentUploadInput = document.getElementById('bg-garment-upload-input');
        const bgBackgroundUploadInput = document.getElementById('bg-background-upload-input');
        const bgGarmentPreview = document.getElementById('bg-garment-preview');
        const bgGarmentPreviewContainer = document.getElementById('bg-garment-preview-container');
        const bgBackgroundPreview = document.getElementById('bg-background-preview');
        const bgBackgroundPreviewContainer = document.getElementById('bg-background-preview-container');
        const bgGeneratedImageContainer = document.getElementById('bg-generated-image-container');
        const bgGeneratedImage = document.getElementById('bg-generated-image');
        const bgAfterContainer = document.getElementById('bg-after-container');
        const scriptingBtn = document.getElementById('scripting-btn');
        const scriptingModal = document.getElementById('scripting-modal');
        const closeScriptingModalBtn = document.getElementById('close-scripting-modal-btn');
        const scriptInput = document.getElementById('script-input');
        const defaultStyleButtonsContainer = document.getElementById('default-style-buttons');
        const colorPaletteButtonsContainer = document.getElementById('color-palette-buttons');
        const generateScriptingBtn = document.getElementById('generate-scripting-btn');
        const scriptingLoading = document.getElementById('scripting-loading');
        const scriptingResults = document.getElementById('scripting-results');
        const mainLoadingContainer = document.getElementById('main-loading-container');
        const detailLoadingContainer = document.getElementById('detail-loading-container');
        const i2iLoadingContainer = document.getElementById('i2i-loading-container');
        const lineartLoadingContainer = document.getElementById('lineart-loading-container');
        const lineartUploadLoadingContainer = document.getElementById('lineart-upload-loading-container');
        const encyclopediaLoading = document.getElementById('encyclopedia-loading');
        const bgLoadingContainer = document.getElementById('bg-loading-container');
        const allLoadingContainers = [mainLoadingContainer, detailLoadingContainer, i2iLoadingContainer, lineartLoadingContainer, lineartUploadLoadingContainer, encyclopediaLoading, bgLoadingContainer, scriptingLoading];

        let currentImageData = null;
        let currentLineArtData = null;
        let uploadedLineartImageData = null;
        let uploadedModelData = null;
        let uploadedGarmentData = null;
        let currentTryOnResultData = null; 
        let originalTryOnResultData = null;
        let uploadedBgGarmentData = null;
        let uploadedBgBackgroundData = null;
        
        const colorPalettesInfo = {
            "å¤§åœ°è‰²ç³»": "å¤§åœ°è‰²ç³»çš„æ ¸å¿ƒå…‰è°±æ„æˆäº†ä¸€å¥—ä¸°å¯Œè€Œå¾®å¦™çš„è‰²å½©è¯æ±‡...æ£•è‰²ç³»ã€ç»¿è‰²ç³»ã€ä¸­æ€§è‰²ã€è“è‰²ç³»...",
            "è«å…°è¿ªè‰²ç³»": "ä»¥æ„å¤§åˆ©ç”»å®¶ä¹”æ²»Â·è«å…°è¿ªå‘½åï¼Œæ ¸å¿ƒç‰¹å¾æ˜¯åœ¨æ‰€æœ‰åŸºè‰²ä¸­èå…¥ä¸€å®šæ¯”ä¾‹çš„ç°è‰²æˆ–ç™½è‰²ï¼Œåˆ›é€ å‡ºä½é¥±å’Œåº¦çš„æŸ”å’Œè‰²è°ƒ...ä»£è¡¨è‰²å½©: çƒŸç²‰è‰², é¼ å°¾è‰ç»¿, é›¾éœ¾è“, é«˜çº§ç°...",
            "é»‘ç™½ç°": "æ ¸å¿ƒæ¦‚å¿µå¹¶éè‰²å½©çš„ç¼ºå¤±ï¼Œè€Œæ˜¯å°†è§†è§‰ç„¦ç‚¹å¼•å‘å…‰å½±ã€å½¢æ€ä¸è´¨æ„Ÿã€‚ç™½è‰²å¼•å…¥å…‰çº¿ï¼Œç°è‰²ä½œä¸ºè¿‡æ¸¡ï¼Œé»‘è‰²æä¾›å¯¹æ¯”...",
            "å¤šå·´èƒºç©¿æ­": "ä»¥é«˜é¥±å’Œåº¦ã€é«˜æ˜åº¦çš„é²œè‰³è‰²å½©ä¸ºæ ¸å¿ƒï¼Œæ—¨åœ¨é€šè¿‡æœè£…ä¸»åŠ¨æå‡æƒ…ç»ª...ä»£è¡¨è‰²å½©: äº®ç²‰è‰², æŸ æª¬é»„, è‰æœ¨ç»¿, å®è“è‰², æ©˜å­æ©™...",
            "éœ“è™¹è‰²ç³»": "æŒ‡äº®åº¦æé«˜ã€é¥±å’Œåº¦è¾¾åˆ°æé™çš„è§å…‰è‰²è°ƒï¼Œè§†è§‰æ•ˆæœä»¿ä½›è‡ªèº«åœ¨å‘å…‰ã€‚å…¶ç¾å­¦æœ¬è´¨æ˜¯äººå·¥æ„Ÿå’Œæœªæ¥æ„Ÿï¼Œä¸æ•°å­—æ–‡åŒ–ã€èµ›åšæœ‹å…‹ç¾å­¦ç´§å¯†ç›¸è¿...",
            "ç²‰å½©è‰²ç³»": "æŒ‡å…·æœ‰è¾ƒé«˜æ˜åº¦å’Œè¾ƒä½é¥±å’Œåº¦çš„é¢œè‰²ï¼Œé€šè¿‡åœ¨çº¯è‰²ä¸­æ··å…¥å¤§é‡ç™½è‰²è€Œå½¢æˆã€‚é€šå¸¸ä¸æ˜¥å¤©ã€ç«¥å¹´ã€æ´å‡€å’Œæ¸©æŸ”ç­‰æ¦‚å¿µç›¸å…³è”...ä»£è¡¨è‰²å½©: å©´å„¿ç²‰, å¤©ç©ºè“, è–„è·ç»¿, è–°è¡£è‰ç´«..."
        };

        function toggleLoading(container, show, message = 'æ­£åœ¨åŠ è½½...') {
            if (!container) return;
            const text = container.querySelector('p');
            if (show) {
                if (text) text.textContent = message;
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        function showErrorMessage(message) {
            allLoadingContainers.forEach(container => toggleLoading(container, false));
            errorMessage.classList.remove('hidden');
            errorText.textContent = `é”™è¯¯: ${message}`;
        }

        async function fetchWithRetry(targetUrl, options, retries = 3) {
            const proxyUrl = '/api/proxy';
            const headers = { 'Content-Type': 'application/json', ...options.headers };
            const proxyPayload = { targetUrl: targetUrl, payload: JSON.parse(options.body) };
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(proxyUrl, { method: 'POST', headers: headers, body: JSON.stringify(proxyPayload) });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        const errorMessage = errorData.error?.details?.error?.message || errorData.error || `HTTP Error: ${response.status}`;
                        throw new Error(errorMessage);
                    }
                    return await response.json();
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(res => setTimeout(res, 1000 * (i + 1)));
                }
            }
        }

        function sanitizePrompt(text) {
            const sensitiveMap = { 'å†…è¡£': 'è´´èº«èƒ¸è¡£', 'èƒ¸ç½©': 'æ–‡èƒ¸', 'å¥¶ç½©': 'æ–‡èƒ¸', 'å†…è£¤': 'è´´èº«åº•è£¤', 'åº•è£¤': 'ä¸‰è§’è£¤' };
            let sanitizedText = text;
            for (const key in sensitiveMap) {
                sanitizedText = sanitizedText.replace(new RegExp(key, 'g'), sensitiveMap[key]);
            }
            if (Object.keys(sensitiveMap).some(term => text.includes(term)) && text.length < 20) {
                return `ä¸€ä»¶æ—¶å°šçš„${sanitizedText}ï¼Œä¸“ä¸šçš„æœè£…è®¾è®¡å›¾ï¼Œçº¯è‰²èƒŒæ™¯çš„äº§å“å±•ç¤ºé£æ ¼`;
            }
            return sanitizedText;
        }

        const getRandomElement = (arr) => arr[Math.floor(Math.random() * arr.length)];

        function addDownloadButton(containerElement, imageUrl, filename) {
            if (!containerElement) return;
            let downloadLink = containerElement.querySelector('.download-btn');
            if (!downloadLink) {
                downloadLink = document.createElement('a');
                downloadLink.className = 'download-btn absolute bottom-2 right-2 p-2 bg-black bg-opacity-50 rounded-full hover:bg-opacity-75 transition-opacity z-10';
                downloadLink.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>`;
                containerElement.appendChild(downloadLink);
            }
            downloadLink.href = imageUrl;
            downloadLink.download = filename;
        }
        
        function copyTextToClipboard(text, buttonElement) {
            if (!text) return;
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.top = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            let success = false;
            try {
                success = document.execCommand('copy');
            } catch (err) {
                showErrorMessage('å¤åˆ¶å¤±è´¥ï¼Œæ‚¨çš„æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒæ­¤æ“ä½œã€‚');
            }
            document.body.removeChild(textArea);
            if (success && buttonElement) {
                const originalText = buttonElement.textContent;
                buttonElement.textContent = 'å·²å¤åˆ¶!';
                setTimeout(() => { buttonElement.textContent = originalText; }, 2000);
            }
        }
        
        async function generateImageFromPrompt(prompt, loadingText) {
            toggleLoading(mainLoadingContainer, true, loadingText);
            [refineBtn, generateBtn, storyBtn, detailBtn, lineartBtn, generateModelBtn, scriptingBtn].forEach(btn => btn.disabled = true);
            storyContainer.classList.add('hidden');
            detailImage.classList.add('hidden');
            generatedImage.classList.add('hidden');
            currentImageData = null;
            storyButtonsContainer.classList.add('hidden');
            modelModificationContainer.classList.add('hidden');
            try {
                const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseModalities: ["IMAGE"] }, };
                const response = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', body: JSON.stringify(payload) });
                const base64Data = response?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                if (base64Data) {
                    const imageUrl = `data:image/png;base64,${base64Data}`;
                    generatedImage.src = imageUrl;
                    generatedImage.classList.remove('hidden');
                    addDownloadButton(imageContainer, imageUrl, 'generated-image.png');
                    currentImageData = base64Data;
                    if (loadingText.includes('æ¨¡ç‰¹')) {
                        modelModificationContainer.classList.remove('hidden');
                    } else {
                        storyBtn.disabled = false;
                        detailBtn.disabled = false;
                        storyButtonsContainer.classList.remove('hidden');
                        storyPromptInput.value = `è¯·æ ¹æ®è¿™å¼ æœè£…è®¾è®¡å›¾ï¼Œç»“åˆæœ€åˆçš„è®¾è®¡ç†å¿µ "${promptInput.value.trim()}"ï¼Œæ’°å†™ä¸€æ®µä¸“ä¸šã€å¸å¼•äººçš„è®¾è®¡è¯´æ˜ã€‚`;
                    }
                } else { showErrorMessage("å›¾ç‰‡ç”Ÿæˆå¤±è´¥æˆ–å†…å®¹è¢«æ‹¦æˆªã€‚"); }
            } catch (error) { showErrorMessage(error.message); } finally {
                toggleLoading(mainLoadingContainer, false);
                [refineBtn, generateBtn, lineartBtn, generateModelBtn, scriptingBtn].forEach(btn => btn.disabled = false);
                generateBtn.disabled = !promptInput.value.trim().length;
            }
        }

        async function generateStory() { 
            if (!currentImageData) return; 
            storyContainer.classList.remove('hidden'); 
            storyText.textContent = 'æ­£åœ¨ç”Ÿæˆè®¾è®¡è¯´æ˜...'; 
            document.getElementById('story-action-buttons').classList.add('hidden'); 
            storyBtn.disabled = true; 
            detailBtn.disabled = true; 
            try { 
                const userInstruction = storyPromptInput.value.trim() || `è¯·æ ¹æ®è¿™å¼ æœè£…è®¾è®¡å›¾ï¼Œç»“åˆæœ€åˆçš„è®¾è®¡ç†å¿µ "${promptInput.value.trim()}"ï¼Œæ’°å†™ä¸€æ®µä¸“ä¸šã€å¸å¼•äººçš„è®¾è®¡è¯´æ˜ã€‚è¯·åªç”¨ä¸­æ–‡å›ç­”ã€‚`; 
                const payload = { contents: [{ role: "user", parts: [{ text: userInstruction }, { inlineData: { mimeType: "image/png", data: currentImageData } }] }] }; 
                const response = await fetchWithRetry(GEMINI_API_URL, { method: 'POST', body: JSON.stringify(payload) }); 
                const storyContent = response?.candidates?.[0]?.content?.parts?.[0]?.text; 
                if (storyContent) { 
                    storyText.textContent = storyContent; 
                    document.getElementById('story-action-buttons').classList.remove('hidden'); 
                } else { 
                    storyText.textContent = `ç”Ÿæˆè¯´æ˜å¤±è´¥ï¼Œæœªæ”¶åˆ°æœ‰æ•ˆå†…å®¹ã€‚`; 
                } 
            } catch (error) { 
                storyText.textContent = `ç”Ÿæˆè¯´æ˜å¤±è´¥: ${error.message}`; 
            } finally { 
                storyBtn.disabled = false; 
                detailBtn.disabled = false; 
            } 
        }

        async function generateModifiedImage(prompt, loadingMessageText = 'æ­£åœ¨ç”Ÿæˆä¿®æ”¹å›¾...') { 
            if (!currentImageData) return; 
            toggleLoading(detailLoadingContainer, true, loadingMessageText);
            detailImage.classList.add('hidden'); 
            const realismPrompt = ` IMPORTANT REALISM INSTRUCTIONS: The result must be a photorealistic image. Strictly adhere to natural human facial proportions. (Negative prompt: anime, cartoon, doll, 3d render, illustration, disproportionate, exaggerated features, giant eyes, manga style:1.5).`;
            const finalPrompt = `Based on the provided image, modify it according to the following instruction: "${prompt}". ${/è„¸|çœ¼|é¼»å­|å˜´|äº”å®˜|çœ‰/.test(prompt) ? realismPrompt : ''}`; 
            const payload = { contents: [{ role: "user", parts: [{ text: finalPrompt }, { inlineData: { mimeType: "image/png", data: currentImageData } }] }], generationConfig: { responseModalities: ["IMAGE"] }, }; 
            try { 
                const response = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', body: JSON.stringify(payload) }); 
                const base64Data = response?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data; 
                if (base64Data) { 
                    const imageUrl = `data:image/png;base64,${base64Data}`; 
                    detailImage.src = imageUrl; 
                    detailImage.classList.remove('hidden'); 
                    addDownloadButton(detailImage.parentElement, imageUrl, 'modified-image.png'); 
                } else { 
                    showErrorMessage("ä¿®æ”¹å›¾ç”Ÿæˆå¤±è´¥ã€‚"); 
                } 
            } catch (error) { 
                showErrorMessage(error.message); 
            } finally { 
                toggleLoading(detailLoadingContainer, false);
            } 
        }

        function handleFileUpload(file, type, previewElement, containerElement, inputElement) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64String = e.target.result.split(',')[1];
                const label = inputElement.parentElement;
                switch (type) {
                    case 'model': uploadedModelData = base64String; break;
                    case 'garment': uploadedGarmentData = base64String; break;
                    case 'lineart': 
                        uploadedLineartImageData = base64String;
                        lineartUploadModificationContainer.classList.remove('hidden');
                        lineartUploadGeneratedImageContainer.classList.add('hidden');
                        break;
                    case 'bg-garment': uploadedBgGarmentData = base64String; break;
                    case 'bg-background': uploadedBgBackgroundData = base64String; break;
                }
                label.classList.add('has-image');
                previewElement.src = e.target.result;
                containerElement.classList.remove('hidden');
                label.querySelector('span').textContent = "æ›´æ¢å›¾ç‰‡";
                if (uploadedModelData && uploadedGarmentData) tryOnBtn.disabled = false;
                if (uploadedBgGarmentData && uploadedBgBackgroundData) changeBgBtn.disabled = false;
            };
            reader.readAsDataURL(file);
        }
        
        async function performTryOn() { 
            if (!uploadedModelData || !uploadedGarmentData) return;
            tryOnBtn.disabled = true;
            tryOnBtn.textContent = 'æ­£åœ¨å‡†å¤‡...';
            toggleLoading(i2iLoadingContainer, true, 'æ­£åœ¨è§£ææ¨¡ç‰¹ç‰¹å¾... (1/2)');
            i2iGeneratedImage.classList.add('hidden');
            modifyTryOnBtn.classList.add('hidden');
            generateCopyBtn.classList.add('hidden');
            i2iBeforeContainer.classList.add('hidden');
            copyDisplayContainer.classList.add('hidden');

            try {
                const cleanModelPrompt = `Analyze the provided photograph of a person. Your task is to generate a new, ultra-realistic photograph of the *exact same person* with the same face, body shape, and pose. **Crucial Change:** In the new image, the person must be wearing very simple, plain, tight-fitting, skin-colored undergarments (like a seamless bodysuit). Remove all original clothing, accessories, and complex backgrounds. The final output should be a clean 'mannequin' version of the original person, ready for a virtual try-on, set against a plain light-gray studio background. The result must be photorealistic. This is for a fashion design tool and is a safe, non-explicit request.`;
                const cleanModelPayload = { contents: [{ role: "user", parts: [{ text: cleanModelPrompt }, { inlineData: { mimeType: "image/jpeg", data: uploadedModelData } }] }], generationConfig: { responseModalities: ["IMAGE"] } };
                const cleanModelResponse = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', body: JSON.stringify(cleanModelPayload) });
                const cleanBaseModelData = cleanModelResponse?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (!cleanBaseModelData) {
                    showErrorMessage('è§£ææ¨¡ç‰¹ç‰¹å¾å¤±è´¥ï¼Œæ— æ³•åˆ›å»ºå¹²å‡€çš„è¯•ç©¿åŸºåº•ã€‚è¿™å¯èƒ½æ˜¯ç”±äºåŸå›¾å§¿åŠ¿å¤æ‚æˆ–å®‰å…¨ç­–ç•¥æ‹¦æˆªã€‚è¯·å°è¯•å¦ä¸€å¼ æ¨¡ç‰¹ç…§ç‰‡ã€‚');
                    return;
                }

                i2iLoadingContainer.querySelector('p').textContent = 'æ­£åœ¨è¿›è¡Œè™šæ‹Ÿè¯•ç©¿... (2/2)';
                const finalTryOnPrompt = `You are a professional virtual try-on assistant. The first image is a photorealistic base model. The second image is a garment (which might be an illustration or a photo). Your task is to accurately place the garment onto the base model. **CRUCIAL:** You must interpret the garment and render it as a photorealistic object. Seamlessly integrate this realistic garment onto the base model, ensuring correct scale, perspective, lighting, and shadows for a natural, high-fashion final photograph.`;
                const finalPayload = { contents: [{ role: "user", parts: [{ text: finalTryOnPrompt }, { inlineData: { mimeType: "image/png", data: cleanBaseModelData } }, { inlineData: { mimeType: "image/jpeg", data: uploadedGarmentData } }] }], generationConfig: { responseModalities: ["IMAGE"] } };
                const finalResponse = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', body: JSON.stringify(finalPayload) });
                const finalBase64Data = finalResponse?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (finalBase64Data) {
                    const imageUrl = `data:image/png;base64,${finalBase64Data}`;
                    originalTryOnResultData = finalBase64Data;
                    currentTryOnResultData = finalBase64Data;
                    i2iGeneratedImage.src = imageUrl;
                    i2iGeneratedImageContainer.classList.remove('hidden');
                    i2iGeneratedImage.classList.remove('hidden');
                    modifyTryOnBtn.classList.remove('hidden');
                    generateCopyBtn.classList.remove('hidden');
                    addDownloadButton(i2iAfterContainer, imageUrl, 'try-on-result.png');
                } else {
                    showErrorMessage("ç”Ÿæˆæ•ˆæœå›¾å¤±è´¥ã€‚");
                }
            } catch (error) {
                showErrorMessage(error.message);
            } finally {
                toggleLoading(i2iLoadingContainer, false);
                tryOnBtn.disabled = false;
                tryOnBtn.textContent = 'ä¸€é”®ç©¿æ­ ğŸ‘•';
            }
        }

        async function performBackgroundChange() {
            if (!uploadedBgGarmentData || !uploadedBgBackgroundData) return;
            changeBgBtn.disabled = true;
            toggleLoading(bgLoadingContainer, true, 'æ­£åœ¨ç§»é™¤èƒŒæ™¯... (1/2)');
            bgGeneratedImage.classList.add('hidden');
            bgGeneratedImageContainer.classList.remove('hidden');
            try {
                const removeBgPrompt = `This is an image of a fashion product. Your task is to remove the background completely, leaving only the product with a transparent background. The output must be a PNG with an alpha channel. This is for a creative tool and is a safe request.`;
                const removeBgPayload = { contents: [{ role: "user", parts: [{ text: removeBgPrompt }, { inlineData: { mimeType: "image/jpeg", data: uploadedBgGarmentData } }] }], generationConfig: { responseModalities: ["IMAGE"] }, };
                const removeBgResponse = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', body: JSON.stringify(removeBgPayload) });
                const transparentGarmentData = removeBgResponse?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (!transparentGarmentData) {
                    showErrorMessage('ç§»é™¤èƒŒæ™¯å¤±è´¥ï¼Œè¯·å°è¯•å¦ä¸€å¼ äº§å“å›¾ã€‚');
                    return;
                }
                bgLoadingContainer.querySelector('p').textContent = 'æ­£åœ¨åˆæˆæ–°å›¾ç‰‡... (2/2)';
                const compositePrompt = `This is a two-part task. The first image is a product with a transparent background. The second image is a new background. Your task is to place the product from the first image realistically onto the new background from the second image. Ensure the lighting, shadows, and perspective are natural and cohesive.`;
                const compositePayload = { contents: [{ role: "user", parts: [{ text: compositePrompt }, { inlineData: { mimeType: "image/png", data: transparentGarmentData } }, { inlineData: { mimeType: "image/jpeg", data: uploadedBgBackgroundData } }] }], generationConfig: { responseModalities: ["IMAGE"] } };
                const compositeResponse = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', body: JSON.stringify(compositePayload) });
                const finalBase64Data = compositeResponse?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (finalBase64Data) {
                    const imageUrl = `data:image/png;base64,${finalBase64Data}`;
                    bgGeneratedImage.src = imageUrl;
                    bgGeneratedImage.classList.remove('hidden');
                    addDownloadButton(bgAfterContainer, imageUrl, 'background-changed-image.png');
                } else {
                    showErrorMessage("åˆæˆæ–°å›¾ç‰‡å¤±è´¥ã€‚");
                }
            } catch (error) {
                showErrorMessage(error.message);
            } finally {
                toggleLoading(bgLoadingContainer, false);
                changeBgBtn.disabled = false;
            }
        }
        
        const vocabData = { 'æ¬¾å¼ç±»åˆ«': { 'Tæ¤': 'T-shirt', 'è¿è¡£è£™': 'Dress', 'å¤¹å…‹': 'Jacket', 'é£è¡£': 'Trench coat', 'å«è¡£': 'Hoodie', 'è£¤å­': 'Pants', 'åŠèº«è£™': 'Skirt', 'è¥¿è£…': 'Blazer', 'è¡¬è¡«': 'Shirt', 'æ¯›è¡£': 'Sweater' }, 'è®¾è®¡é£æ ¼': { 'èµ›åšæœ‹å…‹': 'Cyberpunk', 'å“¥ç‰¹': 'Gothic', 'å¤å¤': 'Vintage', 'æç®€ä¸»ä¹‰': 'Minimalist', 'è¡—å¤´æ½®æµ': 'Streetwear', 'æ³¢è¥¿ç±³äºš': 'Bohemian', 'å­¦é™¢é£': 'Preppy', 'è¿åŠ¨ä¼‘é—²': 'Athleisure', 'æœªæ¥ä¸»ä¹‰': 'Futuristic', 'åºŸåœŸé£': 'Post-apocalyptic' }, 'é¢æ–™æè´¨': { 'ä¸ç»¸': 'Silk', 'ç‰›ä»”å¸ƒ': 'Denim', 'çš®é©': 'Leather', 'æ£‰å¸ƒ': 'Cotton', 'ç¾Šæ¯›': 'Wool', 'ç§‘æŠ€é¢æ–™': 'Techwear fabric', 'é›ªçºº': 'Chiffon', 'å¤©é¹…ç»’': 'Velvet', 'ç½‘çº±': 'Mesh', 'åå…‰ææ–™': 'Reflective material' }, 'å›¾æ¡ˆå°èŠ±': { 'æ ¼çº¹': 'Plaid', 'æ¡çº¹': 'Stripes', 'èŠ±å‰': 'Floral print', 'æŠ½è±¡å‡ ä½•': 'Abstract geometric pattern', 'åŠ¨ç‰©çº¹': 'Animal print', 'æ‰æŸ“': 'Tie-dye', 'çº¯è‰²': 'Solid color', 'logoå°èŠ±': 'Logo print' }, 'ç»†èŠ‚å‰ªè£': { 'ä¸å¯¹ç§°': 'Asymmetrical cut', 'é«˜è…°': 'High-waisted', 'å¤šå£è¢‹': 'Multiple pockets', 'æ‹‰é“¾': 'Zippers', 'å®½æ¾ç‰ˆå‹': 'Oversized fit', 'ä¿®èº«ç‰ˆå‹': 'Slim fit', 'è·å¶è¾¹': 'Ruffles', 'æµè‹': 'Fringes', 'é•‚ç©º': 'Cut-out details', 'æ‹¼æ¥': 'Patchwork' }, 'è‰²å½©æ­é…': { 'è«å…°è¿ªè‰²ç³»': 'Morandi color palette', 'éœ“è™¹è‰²': 'Neon colors', 'é»‘ç™½ç°': 'Monochromatic black and white', 'å¤§åœ°è‰²ç³»': 'Earth tones', 'æ’è‰²': 'Color blocking', 'æ¸å˜è‰²': 'Gradient colors' } };
        function createVocabButtons() { const containers = { 'æ¬¾å¼ç±»åˆ«': document.getElementById('style-type-buttons'), 'è®¾è®¡é£æ ¼': document.getElementById('aesthetic-buttons'), 'é¢æ–™æè´¨': document.getElementById('material-buttons'), 'å›¾æ¡ˆå°èŠ±': document.getElementById('pattern-buttons'), 'ç»†èŠ‚å‰ªè£': document.getElementById('details-buttons'), 'è‰²å½©æ­é…': document.getElementById('color-buttons') }; for (const category in vocabData) { const container = containers[category]; if (!container) continue; for (const term in vocabData[category]) { const btn = document.createElement('button'); btn.textContent = term; btn.className = 'px-4 py-2 text-sm font-medium rounded-full bg-gray-100 hover:bg-indigo-100 text-gray-700 hover:text-indigo-700 transition-colors'; btn.onclick = () => { promptInput.value += `${promptInput.value.trim() ? ', ' : ''}${btn.textContent}`; promptInput.dispatchEvent(new Event('input')); }; container.appendChild(btn); } } }
        async function performModification() { const modificationPrompt = modifyTryOnInput.value.trim(); if (!modificationPrompt || !originalTryOnResultData) return; modifyTryOnModal.classList.add('hidden'); toggleLoading(i2iLoadingContainer, true, 'æ­£åœ¨ä¿®æ”¹æ•ˆæœå›¾...'); i2iGeneratedImage.classList.add('hidden'); try { const realismPrompt = ` IMPORTANT REALISM INSTRUCTIONS: The result must be a photorealistic image. Strictly adhere to natural human facial proportions. (Negative prompt: anime, cartoon, doll, 3d render, illustration, disproportionate, exaggerated features, giant eyes, manga style:1.5).`; const finalPrompt = `Based on the provided image of a model wearing a garment, modify it according to the following instruction: "${modificationPrompt}". ${/è„¸|çœ¼|é¼»å­|å˜´|äº”å®˜|çœ‰/.test(modificationPrompt) ? realismPrompt : ''}`; const payload = { contents: [{ role: "user", parts: [{ text: finalPrompt }, { inlineData: { mimeType: "image/png", data: originalTryOnResultData } }] }], generationConfig: { responseModalities: ["IMAGE"] }, }; const response = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', body: JSON.stringify(payload) }); const base64Data = response?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data; if (base64Data) { const originalImageUrl = `data:image/png;base64,${originalTryOnResultData}`; const modifiedImageUrl = `data:image/png;base64,${base64Data}`; i2iBeforeImage.src = originalImageUrl; addDownloadButton(i2iBeforeContainer, originalImageUrl, 'try-on-original.png'); i2iBeforeContainer.classList.remove('hidden'); currentTryOnResultData = base64Data; i2iGeneratedImage.src = modifiedImageUrl; addDownloadButton(i2iAfterContainer, modifiedImageUrl, 'try-on-modified.png'); generateCopyBtn.classList.remove('hidden'); modifyTryOnInput.value = ''; } else { showErrorMessage("ä¿®æ”¹å¤±è´¥ã€‚"); } } catch (error) { showErrorMessage(error.message); } finally { toggleLoading(i2iLoadingContainer, false); i2iGeneratedImage.classList.remove('hidden'); } }
        async function performGenerateCopy() { if (!currentTryOnResultData) return; generateCopyModal.classList.add('hidden'); toggleLoading(i2iLoadingContainer, true, 'æ­£åœ¨ç”Ÿæˆæ–‡æ¡ˆ...'); copyDisplayContainer.classList.add('hidden'); try { const userInput = generateCopyInput.value.trim(); const prompt = `è¯·æ ¹æ®è¿™å¼ å›¾ç‰‡ï¼Œæ’°å†™ä¸€æ®µæ¨å¹¿æ–‡æ¡ˆã€‚æ–‡æ¡ˆè¦æ±‚å¦‚ä¸‹ï¼š'${userInput}'ã€‚å¦‚æœæ²¡æœ‰è¦æ±‚ï¼Œè¯·è‡ªç”±å‘æŒ¥ï¼Œä¾‹å¦‚åˆ›ä½œä¸€æ®µå°çº¢ä¹¦é£æ ¼çš„æ–‡æ¡ˆã€‚è¯·åªç”¨ä¸­æ–‡å›ç­”ã€‚`; const payload = { contents: [{ role: "user", parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: currentTryOnResultData } }] }] }; const response = await fetchWithRetry(GEMINI_API_URL, { method: 'POST', body: JSON.stringify(payload) }); const copyContent = response?.candidates?.[0]?.content?.parts?.[0]?.text; if (copyContent) { generatedCopyText.textContent = copyContent; copyDisplayContainer.classList.remove('hidden'); } else { showErrorMessage("æ–‡æ¡ˆç”Ÿæˆå¤±è´¥ã€‚"); } generateCopyInput.value = ''; } catch(error) { showErrorMessage(error.message); } finally { toggleLoading(i2iLoadingContainer, false); } }
        async function handleUploadedLineartModify() { const prompt = lineartUploadModificationPrompt.value.trim(); if (!prompt || !uploadedLineartImageData) { showErrorMessage("è¯·å…ˆä¸Šä¼ å›¾ç‰‡å¹¶è¾“å…¥ä¿®æ”¹æŒ‡ä»¤ã€‚"); return; } toggleLoading(lineartUploadLoadingContainer, true, 'æ­£åœ¨ç”Ÿæˆæ–°å›¾ç‰‡...'); lineartUploadGeneratedImageContainer.classList.add('hidden'); const modifyPrompt = `Based on the provided image, redraw it with the following modification: "${prompt}"`; const payload = { contents: [{ role: "user", parts: [ { text: modifyPrompt }, { inlineData: { mimeType: "image/png", data: uploadedLineartImageData } } ] }], generationConfig: { responseModalities: ["IMAGE"] }, }; try { const response = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', body: JSON.stringify(payload) }); const base64Data = response?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data; if (base64Data) { const imageUrl = `data:image/png;base64,${base64Data}`; lineartUploadGeneratedImage.src = imageUrl; lineartUploadGeneratedImageContainer.classList.remove('hidden'); addDownloadButton(lineartUploadGeneratedImageContainer, imageUrl, 'lineart-upload-modified.png'); } else { showErrorMessage('ç”Ÿæˆæ–°å›¾ç‰‡å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚'); } } catch (error) { showErrorMessage(`ç”Ÿæˆå¤±è´¥: ${error.message}`); } finally { toggleLoading(lineartUploadLoadingContainer, false); } }
        async function handleIllustrationToPhoto() { if (!uploadedLineartImageData) { showErrorMessage("è¯·å…ˆä¸Šä¼ ä¸€å¼ è®¾è®¡æ’ç”»ã€‚"); return; } toggleLoading(lineartUploadLoadingContainer, true, 'æ­£åœ¨ç”Ÿæˆè™šæ‹Ÿæ¨¡ç‰¹... (1/2)'); lineartUploadGeneratedImageContainer.classList.add('hidden'); try { const baseModelPrompt = `A photorealistic full-body shot of a fashion model standing in a simple pose, faceless or with an obscured face, against a plain studio background. This image will be used as a base for a virtual try-on.`; const baseModelPayload = { contents: [{ parts: [{ text: baseModelPrompt }] }], generationConfig: { responseModalities: ["IMAGE"] } }; const baseModelResponse = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', body: JSON.stringify(baseModelPayload) }); const baseModelData = baseModelResponse?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data; if (!baseModelData) { showErrorMessage('ç”Ÿæˆè™šæ‹Ÿæ¨¡ç‰¹åŸºåº•å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚'); return; } lineartUploadLoadingContainer.querySelector('p').textContent = 'æ­£åœ¨è¿›è¡Œè™šæ‹Ÿè¯•ç©¿... (2/2)'; const userPrompt = lineartUploadModificationPrompt.value.trim(); const realismPrompt = `(Negative prompt: anime, cartoon, doll, 3d render, illustration, disproportionate, exaggerated features, giant eyes, manga style:1.5).`; const finalTryOnPrompt = `You are a professional virtual try-on assistant. The first image is a photorealistic base model. The second image is a fashion illustration showing a garment. Your task is to accurately place the clothing from the illustration onto the base model. **CRUCIAL:** You must interpret the illustrated garment and render it as a photorealistic object. Seamlessly integrate this realistic garment onto the base model, ensuring correct scale, perspective, lighting, and shadows for a natural, high-fashion final photograph. **Crucial Facial Generation:** The base model may be faceless. You MUST generate a new, unique, and complete photorealistic human face for the final model. Incorporate these additional user instructions: "${userPrompt || 'No additional instructions.'}" ${realismPrompt}`; const finalPayload = { contents: [{ role: "user", parts: [{ text: finalTryOnPrompt }, { inlineData: { mimeType: "image/png", data: baseModelData } }, { inlineData: { mimeType: "image/png", data: uploadedLineartImageData } }] }], generationConfig: { responseModalities: ["IMAGE"] } }; const finalResponse = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', body: JSON.stringify(finalPayload) }); const finalBase64Data = finalResponse?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data; if (finalBase64Data) { const imageUrl = `data:image/png;base64,${finalBase64Data}`; lineartUploadGeneratedImage.src = imageUrl; lineartUploadGeneratedImageContainer.classList.remove('hidden'); addDownloadButton(lineartUploadGeneratedImageContainer, imageUrl, 'illustration-to-photo.png'); } else { showErrorMessage(finalResponse?.candidates?.[0]?.finishReason === 'SAFETY' ? 'æ— æ³•è½¬æ¢ï¼Œå†…å®¹å¯èƒ½è¿åå®‰å…¨æ”¿ç­–ã€‚' : 'æ— æ³•å°†æ’ç”»è½¬ä¸ºç…§ç‰‡ï¼Œè¯·ç¨åå†è¯•ã€‚'); } } catch (error) { showErrorMessage(`ç”Ÿæˆå¤±è´¥: ${error.message}`); } finally { toggleLoading(lineartUploadLoadingContainer, false); } }
        async function handleLineartModify(prompt) { if (!prompt || !currentLineArtData) return; const modifiedWrapper = document.getElementById('lineart-modified-wrapper'); modifiedWrapper.innerHTML = `<div class="text-center py-8"><div class="spinner"></div><p class="mt-2 text-sm font-medium text-gray-600">æ­£åœ¨æ¶¦è‰²...</p></div>`; const modifyPrompt = `Based on the provided fashion line art, redraw it with the following modification: "${prompt}"`; const payload = { contents: [{ role: "user", parts: [{ text: modifyPrompt }, { inlineData: { mimeType: "image/png", data: currentLineArtData } }] }], generationConfig: { responseModalities: ["IMAGE"] }, }; try { const response = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', body: JSON.stringify(payload) }); const base64Data = response?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data; if (base64Data) { const imageUrl = `data:image/png;base64,${base64Data}`; modifiedWrapper.innerHTML = `<img src="${imageUrl}" class="max-w-full h-auto mx-auto rounded-lg shadow-md" alt="Modified Line Art">`; addDownloadButton(modifiedWrapper, imageUrl, 'lineart-modified.png'); } else { modifiedWrapper.innerHTML = ''; showErrorMessage('æ¶¦è‰²å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚'); } } catch (error) { modifiedWrapper.innerHTML = ''; showErrorMessage(`æ¶¦è‰²å¤±è´¥: ${error.message}`); } }
        async function handleEncyclopediaSearch() { const query = encyclopediaInput.value.trim(); if (!query) return; toggleLoading(encyclopediaLoading, true, 'æ­£åœ¨æ£€ç´¢ä¿¡æ¯åº“...'); encyclopediaResults.innerHTML = ''; try { const payload = { contents: [{ parts: [{ text: `Use Google Search to find information about the fashion term "${query}" and provide a concise summary. Respond in Chinese.` }] }], tools: [{ "google_search": {} }]}; const response = await fetchWithRetry(GEMINI_API_URL, { method: 'POST', body: JSON.stringify(payload) }); const encyclopediaContent = response?.candidates?.[0]?.content?.parts?.[0]?.text; if (encyclopediaContent) { encyclopediaResults.innerHTML = `<p class="text-gray-700">${encyclopediaContent.replace(/\n/g, '<br>')}</p>`; } else { encyclopediaResults.innerHTML = `<p class="text-center text-gray-500">æœªèƒ½æ£€ç´¢åˆ°ç›¸å…³ä¿¡æ¯ã€‚</p>`; } } catch (error) { showErrorMessage(error.message); } finally { toggleLoading(encyclopediaLoading, false); } }
        async function handleLineartGeneration() { const query = lineartInput.value.trim(); if (!query) return; toggleLoading(lineartLoadingContainer, true, 'æ­£åœ¨ç”Ÿæˆçº¿ç¨¿...'); lineartResults.innerHTML = ''; currentLineArtData = null; try { const lineArtStyles = [ `A clean, elegant, minimalist fashion line art of: "${query}". Focus on flowing, continuous lines and a simple, sophisticated silhouette. Black ink on a pure white background, vector style.`, `A dynamic, energetic fashion sketch of: "${query}". Emphasize movement with loose, expressive, and sketchy lines. Use cross-hatching for subtle texture. Black pencil on a white background.`, `A detailed, technical yet artistic fashion illustration line drawing of: "${query}". Precise, clean linework that clearly defines seams, drape, and fabric texture. Presented as a professional technical flat sketch.`, `A bold, graphic-style fashion line art of: "${query}". Use thick, confident outlines and high contrast. Minimalist details inside the silhouette to focus on the overall shape. Looks like a modern vector icon.` ]; const lineArtPrompt = getRandomElement(lineArtStyles); const payload = { contents: [{ parts: [{ text: lineArtPrompt }] }], generationConfig: { responseModalities: ["IMAGE"] }, }; const response = await fetchWithRetry(IMAGE_GENERATION_API_URL, { method: 'POST', body: JSON.stringify(payload) }); const base64Data = response?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data; if (base64Data) { currentLineArtData = base64Data; const imageUrl = `data:image/png;base64,${base64Data}`; lineartResults.innerHTML = `<div class="flex flex-col gap-4 items-center"><div id="lineart-original-wrapper" class="relative"><img src="${imageUrl}" class="max-w-full h-auto mx-auto rounded-lg shadow-md" alt="Original Line Art"></div><div id="lineart-modified-wrapper" class="relative"></div></div><div id="lineart-controls" class="mt-4 flex flex-col sm:flex-row justify-center items-center gap-4"><div class="relative"><button id="lineart-modify-btn" class="px-6 py-2 text-white font-bold rounded-full shadow-lg btn btn-quintenary"><span>æ¶¦è‰² ğŸ¨</span></button><div id="lineart-modify-options" class="absolute bottom-full mb-2 w-max bg-white rounded-md shadow-lg z-10 hidden text-left"><a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 font-bold" data-detail-prompt="custom">æ›´å¤šç»†èŠ‚...</a><a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Color this line art.">ä¸€é”®ä¸Šè‰²</a><a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Redraw this in a minimalist style.">æ›´æç®€</a><a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-detail-prompt="Redraw this with more details.">æ›´ç²¾è‡´</a></div></div></div>`; addDownloadButton(document.getElementById('lineart-original-wrapper'), imageUrl, 'lineart-original.png'); document.getElementById('lineart-modify-btn').addEventListener('click', () => document.getElementById('lineart-modify-options').classList.toggle('hidden')); document.getElementById('lineart-modify-options').addEventListener('click', (e) => { e.preventDefault(); if (e.target.tagName !== 'A') return; const p = e.target.dataset.detailPrompt; document.getElementById('lineart-modify-options').classList.add('hidden'); if (p === 'custom') lineartCustomDetailModal.classList.remove('hidden'); else handleLineartModify(p); }); } else { lineartResults.innerHTML = `<p class="text-center text-gray-500">æ— æ³•ç”Ÿæˆçº¿ç¨¿ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯ã€‚</p>`; } } catch (error) { lineartResults.innerHTML = `<p class="text-center text-red-500">ç”Ÿæˆå¤±è´¥ï¼š${error.message}</p>`; } finally { toggleLoading(lineartLoadingContainer, false); } }
        
        async function handleScriptStylingGeneration() {
            const story = scriptInput.value.trim();
            if (!story) { showErrorMessage("è¯·è¾“å…¥åœºæ™¯ã€æ°›å›´æˆ–äººç‰©é£æ ¼ã€‚"); return; }
            toggleLoading(scriptingLoading, true, 'AIé€ å‹å¸ˆæ­£åœ¨æ„æ€ä¸­...');
            scriptingResults.innerHTML = '';
            try {
                const colorInfoString = Object.entries(colorPalettesInfo).map(([key, value]) => `${key}: ${value}`).join('\n');
                const prompt = `ä½ æ˜¯ä¸€ä½é¡¶å°–çš„æ—¶å°šé€ å‹å¸ˆã€‚è¯·æ ¹æ®ä»¥ä¸‹åœºæ™¯æè¿°å’Œè‰²å½©ç†è®ºçŸ¥è¯†ï¼Œç”Ÿæˆä¸€å¥—æ ¸å¿ƒçš„æœè£…æ­é…å»ºè®®ã€‚è¯·ä¸è¦é•¿ç¯‡å¤§è®ºï¼Œç›´æ¥ä»¥â€œæœè£…ï¼šâ€å¼€å¤´ï¼Œç”¨é€—å·åˆ†éš”å…³é”®è¯å’Œå•å“ï¼Œä¾‹å¦‚ï¼šâ€œæœè£…ï¼šç™½è‰²å®½æ¾è¡¬è¡«, æ°´æ´—è“ç‰›ä»”è£¤, å¤å¤è¿åŠ¨é‹, å¸†å¸ƒæ‰˜ç‰¹åŒ…â€ã€‚ä½ çš„å›ç­”åº”è¯¥ç®€æ´ã€ä¸“ä¸šï¼ŒåªåŒ…å«å¯ç”¨äºç”Ÿæˆè®¾è®¡å›¾çš„æè¿°æ€§è¯è¯­ã€‚\n\n---\nè‰²å½©ç†è®ºå‚è€ƒ:\n${colorInfoString}\n---\n\nåœºæ™¯ï¼š\n"${story}"\n\nè¯·ç”¨ä¸­æ–‡å›ç­”ã€‚`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const response = await fetchWithRetry(GEMINI_API_URL, { method: 'POST', body: JSON.stringify(payload) });
                const resultText = response?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (resultText && resultText.trim().startsWith("æœè£…ï¼š")) {
                    const resultTextarea = document.createElement('textarea');
                    resultTextarea.className = 'w-full h-32 p-2 mt-2 border border-gray-300 rounded-md resize-y focus:ring-2 focus:ring-indigo-400';
                    resultTextarea.value = resultText.trim();
                    const sketchButton = document.createElement('button');
                    sketchButton.textContent = 'ç”Ÿæˆæ‰‹ç»˜è®¾è®¡å›¾';
                    sketchButton.className = 'mt-4 px-6 py-2 text-white font-bold rounded-full shadow-lg btn btn-sidenary';
                    sketchButton.onclick = () => {
                        const designPrompt = resultTextarea.value.replace('æœè£…ï¼š', '').trim();
                        if (!designPrompt) { showErrorMessage("æ­é…å»ºè®®ä¸ºç©ºï¼Œæ— æ³•ç”Ÿæˆè®¾è®¡å›¾ã€‚"); return; }
                        promptInput.value = designPrompt;
                        promptInput.dispatchEvent(new Event('input'));
                        const sketchPrompt = `Full body fashion illustration sketch of: ${designPrompt}. Expressive, clean, minimalist line art. Plain white background, professional fashion design style.`;
                        scriptingModal.classList.add('hidden');
                        generateImageFromPrompt(sketchPrompt, 'æ­£åœ¨ç”Ÿæˆæ‰‹ç»˜è®¾è®¡å›¾...');
                    };
                    scriptingResults.appendChild(resultTextarea);
                    scriptingResults.appendChild(sketchButton);
                } else {
                    scriptingResults.innerHTML = `<p class="text-center text-gray-500">æœªèƒ½ç”Ÿæˆæ­é…å»ºè®®ï¼Œè¯·å°è¯•è°ƒæ•´è¾“å…¥å†…å®¹ã€‚</p>`;
                }
            } catch (error) {
                showErrorMessage(error.message);
            } finally {
                toggleLoading(scriptingLoading, false);
            }
        }
        
        function initialize() {
            createVocabButtons();
            notebookTextarea.value = localStorage.getItem('fashionNotebookContent') || '';
            document.querySelectorAll('#vocab-modal h4[data-target]').forEach(title => title.addEventListener('click', () => document.getElementById(title.dataset.target).classList.toggle('hidden')));
            window.addEventListener('click', (e) => { if (e.target === vocabModal) vocabModal.classList.add('hidden'); if (e.target !== generateModelBtn && !generateModelBtn.contains(e.target)) modelOptions.classList.add('hidden'); });
            goToI2IButton.addEventListener('click', () => { mainPage.classList.add('hidden'); i2iPage.classList.remove('hidden'); });
            goToMainButton.addEventListener('click', () => { i2iPage.classList.add('hidden'); mainPage.classList.remove('hidden'); });
            promptInput.addEventListener('input', () => generateBtn.disabled = !promptInput.value.trim().length);
            generateBtn.addEventListener('click', async () => { const p = sanitizePrompt(promptInput.value.trim()); await generateImageFromPrompt(getRandomElement([`Professional high-resolution product photography of a ${p}, studio lighting, plain background.`, `A full-body, professional fashion photoshoot of a model wearing a ${p}, studio lighting, plain background.`]), 'AI æ‘„å½±å¸ˆæ­£åœ¨æ‹æ‘„ä¸­...'); });
            generateModelBtn.addEventListener('click', () => modelOptions.classList.toggle('hidden'));
            modelOptions.addEventListener('click', (e) => { e.preventDefault(); if (e.target.tagName !== 'A') return; const style = e.target.dataset.modelStyle; submitCustomModelBtn.dataset.style = style; customModelTitle.textContent = style === 'sketch' ? 'è‡ªå®šä¹‰æ‰‹ç»˜é£æ ¼æ¨¡ç‰¹' : 'è‡ªå®šä¹‰çœŸå®é£æ ¼æ¨¡ç‰¹'; customModelInput.placeholder = style === 'sketch' ? 'ä¾‹å¦‚ï¼šä¸€ä½å¹´è½»èˆè€…ï¼ŒçŸ­å‘ï¼Œç©¿ç€è¿åŠ¨èƒŒå¿ƒ...' : 'ä¾‹å¦‚ï¼š30å²çš„åè£”å¥³å»ºç­‘å¸ˆï¼Œç©¿ç€å¹²ç»ƒèŒä¸šè£…'; modelOptions.classList.add('hidden'); customModelModal.classList.remove('hidden'); });
            submitCustomModelBtn.addEventListener('click', () => { const userInput = customModelInput.value.trim(); if (!userInput) return showErrorMessage("è¯·è¾“å…¥æ¨¡ç‰¹æè¿°ã€‚"); const style = submitCustomModelBtn.dataset.style; const sanitized = sanitizePrompt(userInput); const prompt = style === 'sketch' ? `Full body fashion illustration sketch: "${sanitized}". Expressive, clean, minimalist line art. Plain white background.` : `Ultra-photorealistic, professional full-body fashion photograph of a model: "${sanitized}". Simple standing pose, plain studio background, soft lighting. IMPORTANT REALISM INSTRUCTIONS: ultra-photorealistic, DSLR photography, sharp focus. (Negative prompt: anime, cartoon, 3d render, illustration, disproportionate).`; customModelModal.classList.add('hidden'); generateImageFromPrompt(prompt, 'æ­£åœ¨ç²¾å‡†ç”Ÿæˆè‡ªå®šä¹‰æ¨¡ç‰¹...'); customModelInput.value = ''; });
            storyBtn.addEventListener('click', generateStory);
            detailBtn.addEventListener('click', () => detailOptions.classList.toggle('hidden'));
            detailOptions.addEventListener('click', (e) => { e.preventDefault(); if (e.target.tagName !== 'A') return; const p = e.target.dataset.detailPrompt; detailOptions.classList.add('hidden'); if (p === 'custom') { customDetailModal.classList.remove('hidden'); } else if (p === 'show-on-model') { generateModifiedImage(`Show this garment on a model ${getRandomElement(["in a modern apartment", "in a bright studio", "against a white wall"])}.`, 'æ­£åœ¨ç”Ÿæˆæ¨¡ç‰¹ä¸Šèº«æ•ˆæœ...'); } else { generateModifiedImage(p, 'æ­£åœ¨æ·±åŒ–è®¾è®¡ç»†èŠ‚...'); } });
            showModifyModelInputBtn.addEventListener('click', () => modifyModelInputArea.classList.toggle('hidden'));
            submitModelModificationBtn.addEventListener('click', () => { if (modifyModelPrompt.value.trim()) generateModifiedImage(modifyModelPrompt.value.trim()); });
            copyStoryBtn.addEventListener('click', () => copyTextToClipboard(storyText.textContent, copyStoryBtn));
            refineBtn.addEventListener('click', () => vocabModal.classList.remove('hidden'));
            i2iModelUploadInput.addEventListener('change', (e) => handleFileUpload(e.target.files[0], 'model', i2iModelPreview, i2iModelPreviewContainer, e.target));
            i2iGarmentUploadInput.addEventListener('change', (e) => handleFileUpload(e.target.files[0], 'garment', i2iGarmentPreview, i2iGarmentPreviewContainer, e.target));
            tryOnBtn.addEventListener('click', performTryOn);
            modifyTryOnBtn.addEventListener('click', () => modifyTryOnModal.classList.remove('hidden'));
            submitModifyTryOnBtn.addEventListener('click', performModification);
            generateCopyBtn.addEventListener('click', () => generateCopyModal.classList.remove('hidden'));
            submitGenerateCopyBtn.addEventListener('click', performGenerateCopy);
            copyGeneratedTextBtn.addEventListener('click', () => copyTextToClipboard(generatedCopyText.textContent, copyGeneratedTextBtn));
            bgGarmentUploadInput.addEventListener('change', (e) => handleFileUpload(e.target.files[0], 'bg-garment', bgGarmentPreview, bgGarmentPreviewContainer, e.target));
            bgBackgroundUploadInput.addEventListener('change', (e) => handleFileUpload(e.target.files[0], 'bg-background', bgBackgroundPreview, bgBackgroundPreviewContainer, e.target));
            changeBgBtn.addEventListener('click', performBackgroundChange);
            closeModalBtn.addEventListener('click', () => vocabModal.classList.add('hidden'));
            closeCustomModalBtn.addEventListener('click', () => customDetailModal.classList.add('hidden'));
            closeCustomModelBtn.addEventListener('click', () => customModelModal.classList.add('hidden'));
            closeModifyTryOnModalBtn.addEventListener('click', () => modifyTryOnModal.classList.add('hidden'));
            closeGenerateCopyModalBtn.addEventListener('click', () => generateCopyModal.classList.add('hidden'));
            lineartCloseCustomModalBtn.addEventListener('click', () => lineartCustomDetailModal.classList.add('hidden'));
            closeEncyclopediaModalBtn.addEventListener('click', () => encyclopediaModal.classList.add('hidden'));
            closeLineartModalBtn.addEventListener('click', () => lineartModal.classList.add('hidden'));
            scriptingBtn.addEventListener('click', () => scriptingModal.classList.remove('hidden'));
            closeScriptingModalBtn.addEventListener('click', () => scriptingModal.classList.add('hidden'));
            generateScriptingBtn.addEventListener('click', handleScriptStylingGeneration);
            defaultStyleButtonsContainer.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON' && e.target.dataset.style) { scriptInput.value = e.target.dataset.style; scriptInput.focus(); } });
            colorPaletteButtonsContainer.addEventListener('click', (e) => { if(e.target.tagName === 'BUTTON') { const color = e.target.textContent; scriptInput.value += `${scriptInput.value ? ' ' : ''}æ­é…${color}è‰²ç³»ã€‚`; scriptInput.focus(); } });
            submitCustomDetailBtn.addEventListener('click', () => { if (customDetailInput.value.trim()) { customDetailModal.classList.add('hidden'); generateModifiedImage(customDetailInput.value.trim(), 'æ­£åœ¨æ·±åŒ–è®¾è®¡ç»†èŠ‚...'); customDetailInput.value = ''; } else showErrorMessage("è¯·è¾“å…¥ä¿®æ”¹æŒ‡ä»¤ã€‚"); });
            notebookToggle.addEventListener('click', () => notebookPanel.classList.toggle('hidden'));
            notebookCopyBtn.addEventListener('click', () => copyTextToClipboard(notebookTextarea.value, notebookCopyBtn));
            notebookClearBtn.addEventListener('click', () => { notebookTextarea.value = ''; localStorage.setItem('fashionNotebookContent', ''); });
            let saveTimeout;
            notebookTextarea.addEventListener('input', () => { clearTimeout(saveTimeout); saveTimeout = setTimeout(() => { localStorage.setItem('fashionNotebookContent', notebookTextarea.value); notebookStatus.classList.remove('opacity-0'); setTimeout(() => notebookStatus.classList.add('opacity-0'), 2000); }, 500); });
            let isDragging = false, offsetX, offsetY;
            notebookHeader.addEventListener('mousedown', (e) => { isDragging = true; offsetX = e.clientX - notebookPanel.offsetLeft; offsetY = e.clientY - notebookPanel.offsetTop; notebookPanel.style.transition = 'none'; document.addEventListener('mousemove', onMouseMove); document.addEventListener('mouseup', onMouseUp); });
            function onMouseMove(e) { if (!isDragging) return; notebookPanel.style.left = `${e.clientX - offsetX}px`; notebookPanel.style.top = `${e.clientY - offsetY}px`; }
            function onMouseUp() { isDragging = false; notebookPanel.style.transition = ''; document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp); }
            encyclopediaToggle.addEventListener('click', () => encyclopediaModal.classList.remove('hidden'));
            encyclopediaSearchBtn.addEventListener('click', handleEncyclopediaSearch);
            lineartBtn.addEventListener('click', () => lineartModal.classList.remove('hidden'));
            lineartGenerateBtn.addEventListener('click', handleLineartGeneration);
            lineartSubmitCustomDetailBtn.addEventListener('click', () => { const p = lineartCustomDetailInput.value.trim(); if (p) { lineartCustomDetailModal.classList.add('hidden'); handleLineartModify(p); lineartCustomDetailInput.value = ''; } else showErrorMessage("è¯·è¾“å…¥ä¿®æ”¹æŒ‡ä»¤ã€‚"); });
            lineartUploadInput.addEventListener('change', (e) => handleFileUpload(e.target.files[0], 'lineart', lineartUploadPreview, lineartUploadPreviewContainer, e.target));
            lineartUploadModifyBtn.addEventListener('click', handleUploadedLineartModify);
            illustrationToPhotoBtn.addEventListener('click', handleIllustrationToPhoto);
        }
        
        initialize();
    </script>
</body>
</html>

